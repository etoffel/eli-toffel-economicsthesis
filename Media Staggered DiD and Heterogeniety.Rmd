---
title: "Staggered DiD Media Coverage Around Carbon Pledges"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

## 1. Load and Prepare Data
```{r load-data}
source("housekeeping.R")

pulled_together <- read_csv("data/clean/MediaDataPulledTogether.csv") %>%
  rename(
    Media_Articles_Total = `Number of Media Articles Total`,
    Negative_Business_Articles = `Negative Business Articles`,
    Negative_Personal_Articles = `Negative Personal Articles`,
    Nexis_Input = `Input into Nexis`,
    Parent_Company = `Parent Company`
  ) %>%
  select(-Nexis_Input, -Parent_Company) %>%
  filter(!is.na(Media_Articles_Total), Years_to_Pledge <= 10, !is.na(Unique_ID)) %>%
  mutate(Year.y = ifelse(Year.y == 0, NA, Year.y))

### Making Table for Counts

# Custom ordering for End_Target
target_order <- c(
  "Net zero", 
  "Carbon neutral(ity)", 
  "Climate neutral", 
  "Carbon negative", 
  "Zero emissions", 
  "Emissions reduction target", 
  "No target"
)

# Set target groupings manually
table_data <- tibble(
  End_Target = c("Net zero", "Carbon neutral(ity)", "Emissions reduction target", 
                 "No target", "Climate neutral", "Carbon negative", "Zero emissions"),
  Count = c(52, 15, 13, 13, 2, 1, 1),
  Group = c("Treatment", "Treatment", "Control", "Control", "Treatment", "Treatment", "Treatment")
) %>%
  mutate(
    End_Target = factor(End_Target, levels = target_order)
  ) %>%
  arrange(End_Target)

# Build the gt table
table_data %>%
  gt() %>%
  cols_label(
    End_Target = "End Target",
    Count = "Count"
  ) %>%
  tab_header(
    title = "Table 1: Carbon Commitment Targets",
    subtitle = "Grouped and ordered by treatment/control classification"
  ) %>%
  fmt_number(
    columns = c(Count),
    decimals = 0
  ) %>%
  tab_style(
    style = cell_fill(color = "#e0f7fa"),
    locations = cells_body(
      rows = Group == "Treatment"
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#f1f8e9"),
    locations = cells_body(
      rows = Group == "Control"
    )
  ) %>%
  grand_summary_rows(
    columns = c(Count),
    fns = list(Total = ~sum(Count)),
    formatter = fmt_number,
    decimals = 0
  )

```

## 2. Create Share of Negative Media Coverage
```{r percent-negative}
pulled_together <- pulled_together %>%
  mutate(
    Percent_Negative_Business = ifelse(Media_Articles_Total > 0,
      pmin(Negative_Business_Articles / Media_Articles_Total * 100, 100), NA),
    Percent_Negative_Personal = ifelse(Media_Articles_Total > 0,
      pmin(Negative_Personal_Articles / Media_Articles_Total * 100, 100), NA)
  )
```

## 3. Staggered DiDs
```{r media-coverage-did, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}

library(fixest)
library(dplyr)
library(gt)
library(gridExtra)
library(grid)
library(png)
library(broom)
library(tidyr)
library(ggplot2)

# --- Run models ---
run_did_model <- function(outcome_var, label) {
  formula <- as.formula(paste0(outcome_var, " ~ sunab(Year.y, Year.x) | Unique_ID + Year.x"))
  model <- feols(formula, data = pulled_together)
  return(list(model = model, label = label))
}

# --- Convert iplot to grob ---
iplot_to_grob <- function(model, main_title) {
  temp <- tempfile(fileext = ".png")
  png(temp, width = 1000, height = 800, res = 150)
  iplot(model,
        main = main_title,
        xlab = "Years Since Pledge",
        ylab = "Estimated Effect")
  dev.off()
  img <- png::readPNG(temp)
  grid::rasterGrob(img, interpolate = TRUE, width = unit(1, "npc"), height = unit(1, "npc"))
}

# Run all three models
total_model <- run_did_model("Media_Articles_Total", "Total Media")
bus_model   <- run_did_model("Percent_Negative_Business", "Negative Business")
pers_model  <- run_did_model("Percent_Negative_Personal", "Negative Personal")

# Generate grobs
grob_total <- iplot_to_grob(total_model$model, total_model$label)
grob_bus   <- iplot_to_grob(bus_model$model, bus_model$label)
grob_pers  <- iplot_to_grob(pers_model$model, pers_model$label)

# Combine plots
grid.arrange(
  grobs = list(grob_total, grob_bus, grob_pers),
  ncol = 3,
  top = textGrob("Figure A1: Staggered DiD – Media Coverage", gp = gpar(fontsize = 16, fontface = "bold")),
  padding = unit(0.5, "line")
)

# --- Table: Post-treatment only (event_time ≥ 0) ---
extract_did <- function(model, label) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(
      event_time = as.numeric(gsub("Year.x::", "", term))
    ) %>%
    filter(event_time >= 0) %>%  # Post-treatment only
    mutate(
      year_label = paste0("Year ", event_time),
      estimate = round(estimate, 2),
      std.error = round(std.error, 2)
    ) %>%
    select(year_label, estimate, std.error) %>%
    pivot_longer(cols = c(estimate, std.error), names_to = "type", values_to = "value") %>%
    mutate(row_label = ifelse(type == "estimate", label, paste(label, "SE"))) %>%
    select(row_label, year_label, value)
}

# Extract each model
table_total <- extract_did(total_model$model, total_model$label)
table_bus   <- extract_did(bus_model$model,   bus_model$label)
table_pers  <- extract_did(pers_model$model,  pers_model$label)

# Combine and pivot
combined_table <- bind_rows(table_total, table_bus, table_pers) %>%
  pivot_wider(names_from = year_label, values_from = value)

# Display table
gt(combined_table) %>%
  tab_header(
    title = md("**Table A1. Media Coverage Effects (Staggered DiD)**"),
    subtitle = "Post-Treatment Years Only (Years ≥ 0)"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

```
## 4. Carbon Credit Heterogeneity (Combined)
```{r carbon-credit-did-9plots-percent-negatives, warning=FALSE, message=FALSE, fig.width=9, fig.height=9}
# Load required packages
library(tidyverse)
library(fixest)
library(broom)
library(gt)
library(grid)
library(gridExtra)
library(png)

# --- Helper to extract estimates only
extract_estimates_only <- function(model, outcome_label, group_label) {
  tidy(model) %>%
    filter(str_detect(term, "Year\\.x::")) %>%
    mutate(
      event_time = str_replace(term, "Year\\.x::", "Year "),
      row_label = paste(outcome_label, "-", group_label),
      estimate = round(estimate, 2)
    ) %>%
    select(row_label, event_time, estimate)
}

# --- Helper to convert iplot() to grob
iplot_to_grob <- function(model, main_title) {
  temp <- tempfile(fileext = ".png")
  png(temp, width = 600, height = 500)
  iplot(model, main = main_title, xlab = "Years Since Pledge", ylab = "Effect")
  dev.off()
  img <- png::readPNG(temp)
  rasterGrob(img, interpolate = TRUE)
}

# --- Outcomes and labels
outcomes <- list(
  Media_Articles_Total = "Total Media",
  Percent_Negative_Business = "% Negative Business",
  Percent_Negative_Personal = "% Negative Personal"
)
credit_groups <- c("Not Specified", "Yes", "No")

# --- Initialize containers
estimates_list <- list()
iplot_grobs <- list()

# --- Run models and plots
for (outcome_var in names(outcomes)) {
  for (group in credit_groups) {
    label <- outcomes[[outcome_var]]
    display_label <- paste(label, "-", group)
    
    subset_data <- pulled_together %>%
      filter((Treated == 1 & Carbon_Credits == group) | Treated == 0)
    
    fml <- as.formula(paste0(outcome_var, " ~ sunab(Year.y, Year.x) | Unique_ID + Year.x"))
    model <- feols(fml, data = subset_data)
    
    # Save estimates and plots
    estimates_list[[display_label]] <- extract_estimates_only(model, label, group)
    iplot_grobs[[display_label]] <- iplot_to_grob(model, display_label)
  }
}

# # --- Table of Estimates (no SE)
# combined_table <- bind_rows(estimates_list) %>%
#   pivot_wider(names_from = event_time, values_from = estimate)
# 
# gt(combined_table) %>%
#   tab_header(title = "Table 7. Staggered DiD Estimates (Percent Negatives + Total Media)") %>%
#   tab_style(
#     style = cell_text(weight = "bold"),
#     locations = cells_column_labels(everything())
#   )

# --- Plot all 9 results
grid.arrange(
  grobs = iplot_grobs,
  ncol = 3,
  top = textGrob("Figure 7: Staggered DiD by Carbon Credit Group and Media Outcome",
                 gp = gpar(fontsize = 14, fontface = "bold"))
)

```


## Interim Target Year Heterogeneity – Staggered DiD on Media Outcomes

```{r interim-target-heterogeneity-media, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}
# Ensure Interim_Target_Year is numeric
pulled_together <- pulled_together %>%
  mutate(Interim_Target_Year = as.numeric(Interim_Target_Year))

# Helper function to run DiD and plot
run_interim_did_plot <- function(data, outcome_var, label, cutoff_group) {
  fml <- as.formula(paste0(outcome_var, " ~ sunab(Year.y, Year.x) | Unique_ID + Year.x"))
  model <- feols(fml, data = data)
  
  iplot(
    model,
    main = paste("Staggered DiD:", label, "- Interim Target", cutoff_group),
    xlab = "Years Since Pledge",
    ylab = paste("Effect on", label)
  )
}

# Define outcomes and labels
outcomes <- list(
  Media_Articles_Total = "Total Media Articles",
  Percent_Negative_Business = "% Negative Business Articles",
  Percent_Negative_Personal = "% Negative Personal Articles"
)

# Loop through outcomes and Interim Target year groups
for (outcome_var in names(outcomes)) {
  label <- outcomes[[outcome_var]]
  
  # Group: Interim_Target_Year > 2000 or untreated
  subset_after_2000 <- pulled_together %>%
    filter((Treated == 1 & Interim_Target_Year > 2000) | Treated == 0)
  
  run_interim_did_plot(subset_after_2000, outcome_var, label, "> 2000")
  
  # Group: Interim_Target_Year < 2000 or untreated
  subset_before_2000 <- pulled_together %>%
    filter((Treated == 1 & Interim_Target_Year < 2000) | Treated == 0)
  
  run_interim_did_plot(subset_before_2000, outcome_var, label, "< 2000")
}

# Ensure Interim_Target_Year is numeric
pulled_together <- pulled_together %>%
  mutate(Interim_Target_Year = as.numeric(Interim_Target_Year))

# Helper to extract estimates (without SEs)
extract_estimates_only <- function(model, outcome_label, group_label) {
  tidy(model) %>%
    filter(str_detect(term, "Year\\.x::")) %>%
    mutate(
      event_time = str_replace(term, "Year\\.x::", "Year "),
      row_label = paste(outcome_label, "-", group_label),
      estimate = round(estimate, 2)
    ) %>%
    select(row_label, event_time, estimate)
}

# Convert iplot to grob
iplot_to_grob <- function(model, main_title) {
  temp <- tempfile(fileext = ".png")
  png(temp, width = 600, height = 500)
  iplot(model, main = main_title, xlab = "Years Since Pledge", ylab = "Effect")
  dev.off()
  img <- png::readPNG(temp)
  rasterGrob(img, interpolate = TRUE)
}

# Outcomes
outcomes <- list(
  Media_Articles_Total = "Total Media",
  Percent_Negative_Business = "Negative Business",
  Percent_Negative_Personal = "Negative Personal"
)

iplot_grobs <- list()
estimates_list <- list()

# Loop through outcomes and run models for both Interim Target groups
for (outcome_var in names(outcomes)) {
  label <- outcomes[[outcome_var]]

  # Group 1: Interim Target > 2000
  subset_with_target <- pulled_together %>%
    filter((Treated == 1 & Interim_Target_Year > 2000) | Treated == 0)

  model_with_target <- feols(as.formula(paste0(outcome_var, " ~ sunab(Year.y, Year.x) | Unique_ID + Year.x")),
                             data = subset_with_target)
  iplot_grobs[[paste(label, "Interim Target")]] <- iplot_to_grob(model_with_target, paste(label, "Interim Target"))
  estimates_list[[paste(label, "Interim Target")]] <- extract_estimates_only(model_with_target, label, "Interim Target")

  # Group 2: Interim Target < 2000
  subset_no_target <- pulled_together %>%
    filter((Treated == 1 & Interim_Target_Year < 2000) | Treated == 0)

  model_no_target <- feols(as.formula(paste0(outcome_var, " ~ sunab(Year.y, Year.x) | Unique_ID + Year.x")),
                           data = subset_no_target)
  iplot_grobs[[paste(label, "No Interim Target")]] <- iplot_to_grob(model_no_target, paste(label, "No Interim Target"))
  estimates_list[[paste(label, "No Interim Target")]] <- extract_estimates_only(model_no_target, label, "No Interim Target")
}

# Plot all 6 in a grid (2 rows × 3 columns)
grid.arrange(
  grobs = iplot_grobs,
  ncol = 3,
  top = textGrob("Figure 8: Staggered DiD – Interim Target Year Heterogeneity", gp = gpar(fontsize = 14, fontface = "bold"))
)

# Table: Combine all estimates
combined_table <- bind_rows(estimates_list) %>%
  pivot_wider(names_from = event_time, values_from = estimate)

# Display table
gt(combined_table) %>%
  tab_header(title = "Table 8. Staggered DiD Estimates by Interim Target Group (Estimates Only)") %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

```
## Net Zero Year Heterogeneity – Staggered DiD on Media Outcomes
```{r net-zero-year-heterogeneity-media, fig.width=12, fig.height=9, warning=FALSE, message=FALSE}

library(fixest)
library(dplyr)
library(gridExtra)
library(grid)
library(png)
library(broom)

# Ensure Net_Zero_Year is numeric
pulled_together <- pulled_together %>%
  mutate(Net_Zero_Year = as.numeric(Net_Zero_Year))

# Define outcomes and labels
outcomes <- list(
  Media_Articles_Total = "Total Media Articles",
  Percent_Negative_Business = "% Negative Business Articles",
  Percent_Negative_Personal = "% Negative Personal Articles"
)

# Define plotting function
iplot_to_grob <- function(model, title) {
  temp <- tempfile(fileext = ".png")
  png(temp, width = 1000, height = 800, res = 150)
  iplot(
    model,
    main = title,
    xlab = "Years Since Pledge",
    ylab = "Estimated Effect"
  )
  dev.off()
  img <- png::readPNG(temp)
  rasterGrob(img, interpolate = TRUE, width = unit(1, "npc"), height = unit(1, "npc"))
}

# Initialize list to store all grobs
all_grobs <- list()

# Loop over outcomes and Net Zero groups
for (outcome_var in names(outcomes)) {
  label <- outcomes[[outcome_var]]
  
  # Subset for Net Zero Year ≤ 2035 or untreated
  data_before <- pulled_together %>%
    filter((Treated == 1 & Net_Zero_Year <= 2035) | Treated == 0)
  model_before <- feols(as.formula(paste0(outcome_var, " ~ sunab(Year.y, Year.x) | Unique_ID + Year.x")),
                        data = data_before)
  grob_before <- iplot_to_grob(model_before, paste(label, "\nNet Zero Year ≤ 2035"))
  all_grobs[[length(all_grobs) + 1]] <- grob_before
  
  # Subset for Net Zero Year > 2035 or untreated
  data_after <- pulled_together %>%
    filter((Treated == 1 & Net_Zero_Year > 2035) | Treated == 0)
  model_after <- feols(as.formula(paste0(outcome_var, " ~ sunab(Year.y, Year.x) | Unique_ID + Year.x")),
                       data = data_after)
  grob_after <- iplot_to_grob(model_after, paste(label, "\nNet Zero Year > 2035"))
  all_grobs[[length(all_grobs) + 1]] <- grob_after
}

# Arrange in 3x2 grid (3 outcomes × 2 groups)
grid.arrange(
  grobs = all_grobs,
  ncol = 2,
  top = textGrob("Figure A2: Media Coverage Heterogeneity by Net Zero Target Year",
                 gp = gpar(fontsize = 16, fontface = "bold"))
)

# --- Table: Years 0, 1, and 2 only ---
extract_did <- function(model, label) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(
      event_time = as.numeric(gsub("Year.x::", "", term))
    ) %>%
    filter(event_time %in% c(0, 1, 2)) %>%  # ← Only keep Year 0–2
    mutate(
      year_label = paste0("Year ", event_time),
      estimate = round(estimate, 2),
      std.error = round(std.error, 2)
    ) %>%
    select(year_label, estimate, std.error) %>%
    pivot_longer(cols = c(estimate, std.error), names_to = "type", values_to = "value") %>%
    mutate(row_label = ifelse(type == "estimate", label, paste(label, "SE"))) %>%
    select(row_label, year_label, value)
}

# Define outcome labels
outcomes <- list(
  Media_Articles_Total = "Total Media Articles",
  Percent_Negative_Business = "% Negative Business Articles",
  Percent_Negative_Personal = "% Negative Personal Articles"
)

# Define model runner
run_nz_model <- function(var, data_filter, label) {
  model <- feols(as.formula(paste0(var, " ~ sunab(Year.y, Year.x) | Unique_ID + Year.x")), data = data_filter)
  return(list(model = model, label = label))
}

# Subset groups
subset_nz_before <- pulled_together %>%
  filter((Treated == 1 & Net_Zero_Year <= 2035) | Treated == 0)

subset_nz_after <- pulled_together %>%
  filter((Treated == 1 & Net_Zero_Year > 2035) | Treated == 0)

# Run and label models
total_model_before <- run_nz_model("Media_Articles_Total", subset_nz_before, "Total Media ≤ 2035")
total_model_after  <- run_nz_model("Media_Articles_Total", subset_nz_after,  "Total Media > 2035")

bus_model_before   <- run_nz_model("Percent_Negative_Business", subset_nz_before, "% Negative Business ≤ 2035")
bus_model_after    <- run_nz_model("Percent_Negative_Business", subset_nz_after,  "% Negative Business > 2035")

pers_model_before  <- run_nz_model("Percent_Negative_Personal", subset_nz_before, "% Negative Personal ≤ 2035")
pers_model_after   <- run_nz_model("Percent_Negative_Personal", subset_nz_after,  "% Negative Personal > 2035")

# Extract and format
table_total_before <- extract_did(total_model_before$model, total_model_before$label)
table_total_after  <- extract_did(total_model_after$model,  total_model_after$label)

table_bus_before   <- extract_did(bus_model_before$model,   bus_model_before$label)
table_bus_after    <- extract_did(bus_model_after$model,    bus_model_after$label)

table_pers_before  <- extract_did(pers_model_before$model,  pers_model_before$label)
table_pers_after   <- extract_did(pers_model_after$model,   pers_model_after$label)

# Combine
combined_table <- bind_rows(
  table_total_before, table_total_after,
  table_bus_before, table_bus_after,
  table_pers_before, table_pers_after
) %>%
  pivot_wider(names_from = year_label, values_from = value)

# Display with gt
gt(combined_table) %>%
  tab_header(
    title = md("**Table A2. Media Coverage Effects by Net Zero Target Year**"),
    subtitle = "Years 0 to 2 Only (Pledge Year and Two Years After)"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

```
## 5. Accountability Heterogeneity – Staggered DiD by Media Outcomes


```{r accountability-heterogeneity, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}
library(fixest)
library(dplyr)
library(gt)
library(stringr)
library(grid)
library(gridExtra)
library(png)

# Helper function to extract point estimates only
extract_estimates_only <- function(model, outcome_label, group_label) {
  tidy(model) %>%
    filter(str_detect(term, "Year\\.x::")) %>%
    mutate(
      event_time = str_replace(term, "Year\\.x::", "Year "),
      row_label = paste(outcome_label, "-", group_label),
      estimate = round(estimate, 2)
    ) %>%
    select(row_label, event_time, estimate)
}

# Helper to convert iplot into a grob
iplot_to_grob <- function(model, main_title) {
  temp <- tempfile(fileext = ".png")
  png(temp, width = 600, height = 500)
  iplot(model, main = main_title, xlab = "Years Since Pledge", ylab = "Effect")
  dev.off()
  img <- png::readPNG(temp)
  rasterGrob(img, interpolate = TRUE)
}

# Define groups and outcomes
accountability_groups <- c("Not Specified", "Yes", "No")
outcomes <- list(
  Media_Articles_Total = "Total Media",
  Percent_Negative_Business = "Negative Business %",
  Percent_Negative_Personal = "Negative Personal %"
)

# Run models, create grobs and store estimates
iplot_grobs <- list()
estimates_list <- list()

for (outcome_var in names(outcomes)) {
  for (group in accountability_groups) {
    label <- paste(outcomes[[outcome_var]], "-", group)
    
    subset_data <- pulled_together %>%
      filter((Treated == 1 & Accountability_delivery == group) | Treated == 0)
    
    fml <- as.formula(paste0(outcome_var, " ~ sunab(Year.y, Year.x) | Unique_ID + Year.x"))
    model <- feols(fml, data = subset_data)
    
    iplot_grobs[[label]] <- iplot_to_grob(model, label)
    estimates_list[[label]] <- extract_estimates_only(model, outcomes[[outcome_var]], group)
  }
}

# Combine and format table
combined_table <- bind_rows(estimates_list) %>%
  pivot_wider(names_from = event_time, values_from = estimate)

# Display GT Table
gt(combined_table) %>%
  tab_header(title = "Table 10. Staggered DiD Estimates by Accountability Group (Estimates Only)") %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

# Display 9 plots in 3x3 grid
grid.arrange(
  grobs = iplot_grobs,
  ncol = 3,
  top = textGrob("Figure 10: Staggered DiD by Accountability Delivery", gp = gpar(fontsize = 14, fontface = "bold"))
)

```