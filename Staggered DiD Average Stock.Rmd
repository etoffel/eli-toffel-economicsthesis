---
title: "Staggered DiD: Carbon Pledge Impact on Stock Price"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(fixest)
library(broom)
library(ggplot2)
```

## 1. Load Data and Preprocessing

```{r load-data}
source("housekeeping.R")

carbon_neutral <- read_csv("data/Build 2/Carbon Neutral Pledging Data.csv")
stock_data <- read_csv("data/Build 2/Stock Data.csv")
revenue_data <- read_csv("data/Build 2/Revenue Data.csv")
View()
# Fix Unique ID for Burger King
stock_data <- stock_data %>% mutate(`Unique ID` = ifelse(Company == "Burger King", 69, `Unique ID`))
revenue_data <- revenue_data %>% mutate(`Unique ID` = ifelse(Company == "Burger King", 69, `Unique ID`))
```

## 2. Merge and Clean Data
```{r merge-clean}
merged_data2 <- stock_data %>% left_join(carbon_neutral, by = "Unique ID")

merged_data2 <- merged_data2 %>%
  rename(
    Unique_ID = `Unique ID`,
    Avg_Stock_Price = `Average Stock Price`,
    Year_Open = `Year Open`,
    Year_High = `Year High`,
    Year_Low = `Year Low`,
    Year_Close = `Year Close`,
    Annual_Change = `Annual % Change`,
    End_Target = `End Target`,
    Target_Reduction = `End_target_percentage_reduction`,
    Target_Baseline_Year = `End_target_baseline_year2`,
    Target_Completion_Year = `End_target_year`,
    Target_Status = `Status_of_end_target`,
    Last_Update = `Date_of_last_status_update`,
    Target_Details = `End_target_text`,
    Interim_Target = `Interim_target`,
    Interim_Target_Year = `Interim_target_year`,
    Interim_Target_Reduction = `Interim_target_percentage_reduction`,
    Interim_Target_Baseline = `Interim_target_baseline_year`,
    Interim_Target_Details = `Interim_target_text`,
    Target_Notes = `Targets_notes`,
    Scope_1 = `Scope_1_coverage`,
    Scope_2 = `Scope_2_coverage`,
    Scope_3 = `Scope_3_coverage`,
    Published_Plan = `Published_plan`,
    Reporting_Method = `Reporting_mechanism`,
    Carbon_Credits = `Carbon_credits`,
    Credit_Conditions = `Carbon_credits_conditions`,
    Emissions = `GHG_emissions`,
    Emissions_Year = `GHG_emissions_year`,
    Pledge_Date = `Date of Carbon Pledge`,
    Net_Zero_Year = `Carbon Neutral or Net Zero by`,
    Revenue = `Company_annual_revenue`,
    Industry = `Industry`,
    Employees = `Employees`,
    Additional_Notes = `Notes`
  )

# Manual corrections
merged_data2 <- merged_data2 %>%
  mutate(Year.y = ifelse(Unique_ID == 18, 2021, Year.y),
         Year.x = ifelse(Year.x == 25, 2025, Year.x),
         End_Target = case_when(
           Unique_ID == 98 & Company.x == "Yum! Brands" ~ "Net zero",
           Unique_ID == 60 & Company.x == "Netflix" ~ "Net zero",
           TRUE ~ End_Target
         ))
```

## 3. Set Treatment and Placebo Variables

```{r treatment}
merged_data2 <- merged_data2 %>%
  filter(!is.na(Avg_Stock_Price)) %>%
  mutate(
    Treated = ifelse(!is.na(Year.y) & Year.y != 0, 1, 0),
    Year.y = ifelse(Treated == 0, NA, Year.y)
  )
```

## 4. Run Staggered DiD Model

```{r Staggered DiD}
staggered_model <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = merged_data2
)
View(merged_data2)

summary(staggered_model)
```

## 5. Visualize Staggered DiD Results

```{r plot-staggered-did}
iplot(
  staggered_model,
  main = "Staggered DiD: Effect on Avg. Stock Price",
  xlab = "Years Since Pledge",
  ylab = "Estimated Effect on Stock Price"
)
```

## 6. Carbon Credits Heterogeniety

```{r carbon-credit-heterogeneity, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}

subset_data <- merged_data2 %>%
  filter((Treated == 1 & Carbon_Credits == "Not Specified") | Treated == 0)

staggered_model <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_data
)

iplot(
  staggered_model,
  main = "Staggered DiD: Not Specified Carbon Credits - Effect on Avg. Stock Price",
  xlab = "Years Since Pledge",
  ylab = "Estimated Effect on Stock Price"
)

# Filter: Treated firms with Carbon Credits == "Yes" OR all untreated firms
subset_yes <- merged_data2 %>%
  filter((Treated == 1 & Carbon_Credits == "Yes") | Treated == 0)

# Run Staggered DiD regression
staggered_model_yes <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_yes
)

# Visualize results
iplot(
  staggered_model_yes,
  main = "Staggered DiD: Carbon Credits = Yes",
  xlab = "Years Since Pledge",
  ylab = "Estimated Effect on Stock Price"
)

# Filter: Treated firms with Carbon Credits == "No" OR all untreated firms
subset_no <- merged_data2 %>%
  filter((Treated == 1 & Carbon_Credits == "No") | Treated == 0)

# Run Staggered DiD regression
staggered_model_no <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_no
)

# Visualize results
iplot(
  staggered_model_no,
  main = "Staggered DiD: Carbon Credits = No",
  xlab = "Years Since Pledge",
  ylab = "Estimated Effect on Stock Price"
)

```
## Accountability Heterogeniety
```{r Accountability-heterogeneity, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}

# --- Not Specified Group ---
subset_acc_unspecified <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Not Specified") | Treated == 0)

staggered_model_unspecified <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_acc_unspecified
)

iplot(
  staggered_model_unspecified,
  main = "Staggered DiD: Accountability = Not Specified",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

# --- Yes Group ---
subset_acc_yes <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Yes") | Treated == 0)

staggered_model_yes <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_acc_yes
)

iplot(
  staggered_model_yes,
  main = "Staggered DiD: Accountability = Yes",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

# --- No Group ---
subset_acc_no <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "No") | Treated == 0)

staggered_model_no <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_acc_no
)

iplot(
  staggered_model_no,
  main = "Staggered DiD: Accountability = No",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)
```

## Interm Target
```{r Interm-heterogeneity, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}

# Convert Interim_Target_Year to numeric if it's not already
merged_data2 <- merged_data2 %>%
  mutate(Interim_Target_Year = as.numeric(Interim_Target_Year))

# --- Subset: Treated firms with interim target > 2000 OR untreated firms
subset_interim_target <- merged_data2 %>%
  filter((Treated == 1 & Interim_Target_Year > 2000) | Treated == 0)

# Run Staggered DiD model
staggered_model_interim <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_interim_target
)

# Plot results
iplot(
  staggered_model_interim,
  main = "Staggered DiD: Interim Target Year > 2000",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)


# Filter: Treated firms with Interim_Target_Year < 2000 OR all untreated firms
subset_interim_before_2000 <- merged_data2 %>%
  filter((Treated == 1 & Interim_Target_Year < 2000) | Treated == 0)

# Run the Staggered DiD regression
staggered_model_interim_before_2000 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_interim_before_2000
)

# Plot results
iplot(
  staggered_model_interim_before_2000,
  main = "Staggered DiD: Interim Target Year < 2000 vs Control",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

```
```{r final-year-heterogeneity, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}

# Ensure Net_Zero_Year is numeric
merged_data2 <- merged_data2 %>%
  mutate(Net_Zero_Year = as.numeric(Net_Zero_Year))

# Filter: Treated firms with Net_Zero_Year <= 2035 OR all untreated firms
subset_netzero_before_2035 <- merged_data2 %>%
  filter((Treated == 1 & Net_Zero_Year <= 2035) | Treated == 0)

# Run the Staggered DiD regression
staggered_model_nz_before_2035 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_netzero_before_2035
)

# Plot results
iplot(
  staggered_model_nz_before_2035,
  main = "Staggered DiD: Net Zero Year ≤ 2035 vs Control",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

# Filter: Treated firms with Net_Zero_Year > 2035 OR all untreated firms
subset_netzero_after_2035 <- merged_data2 %>%
  filter((Treated == 1 & Net_Zero_Year > 2035) | Treated == 0)

# Run the Staggered DiD regression
staggered_model_nz_after_2035 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_netzero_after_2035
)

# Plot results
iplot(
  staggered_model_nz_after_2035,
  main = "Staggered DiD: Net Zero Year > 2035 vs Control",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)
```
## Net Zero Year Heterogeneity – Staggered DiD on Media Outcomes

```{r net-zero-year-heterogeneity-media, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}
# Ensure Net_Zero_Year is numeric
pulled_together <- pulled_together %>%
  mutate(Net_Zero_Year = as.numeric(Net_Zero_Year))

# Helper function to run DiD and plot
run_nz_did_plot <- function(data, outcome_var, label, group_desc) {
  fml <- as.formula(paste0(outcome_var, " ~ sunab(Year.y, Year.x) | Unique_ID + Year.x"))
  model <- feols(fml, data = data)
  
  iplot(
    model,
    main = paste("Staggered DiD:", label, "- Net Zero Year", group_desc),
    xlab = "Years Since Pledge",
    ylab = paste("Effect on", label)
  )
}

# Define outcomes and labels
outcomes <- list(
  Media_Articles_Total = "Total Media Articles",
  Percent_Negative_Business = "% Negative Business Articles",
  Percent_Negative_Personal = "% Negative Personal Articles"
)

# Loop through outcomes and Net Zero Year groups
for (outcome_var in names(outcomes)) {
  label <- outcomes[[outcome_var]]
  
  # Group: Net_Zero_Year ≤ 2035 or untreated
  subset_nz_before_2035 <- pulled_together %>%
    filter((Treated == 1 & Net_Zero_Year <= 2035) | Treated == 0)
  
  run_nz_did_plot(subset_nz_before_2035, outcome_var, label, "≤ 2035")
  
  # Group: Net_Zero_Year > 2035 or untreated
  subset_nz_after_2035 <- pulled_together %>%
    filter((Treated == 1 & Net_Zero_Year > 2035) | Treated == 0)
  
  run_nz_did_plot(subset_nz_after_2035, outcome_var, label, "> 2035")
}

```