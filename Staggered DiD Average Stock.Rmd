---
title: "Staggered DiD: Carbon Pledge Impact on Stock Price"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

## 1. Load Data and Preprocessing

```{r load-data}
source("housekeeping.R")

carbon_neutral <- read_csv("data/Build 2/Carbon Neutral Pledging Data.csv")
stock_data <- read_csv("data/Build 2/Stock Data.csv")
revenue_data <- read_csv("data/Build 2/Revenue Data.csv")
View()
# Fix Unique ID for Burger King
stock_data <- stock_data %>% mutate(`Unique ID` = ifelse(Company == "Burger King", 69, `Unique ID`))
revenue_data <- revenue_data %>% mutate(`Unique ID` = ifelse(Company == "Burger King", 69, `Unique ID`))
```

## 2. Merge and Clean Data
```{r merge-clean}
merged_data2 <- stock_data %>% left_join(carbon_neutral, by = "Unique ID")

merged_data2 <- merged_data2 %>%
  rename(
    Unique_ID = `Unique ID`,
    Avg_Stock_Price = `Average Stock Price`,
    Year_Open = `Year Open`,
    Year_High = `Year High`,
    Year_Low = `Year Low`,
    Year_Close = `Year Close`,
    Annual_Change = `Annual % Change`,
    End_Target = `End Target`,
    Target_Reduction = `End_target_percentage_reduction`,
    Target_Baseline_Year = `End_target_baseline_year2`,
    Target_Completion_Year = `End_target_year`,
    Target_Status = `Status_of_end_target`,
    Last_Update = `Date_of_last_status_update`,
    Target_Details = `End_target_text`,
    Interim_Target = `Interim_target`,
    Interim_Target_Year = `Interim_target_year`,
    Interim_Target_Reduction = `Interim_target_percentage_reduction`,
    Interim_Target_Baseline = `Interim_target_baseline_year`,
    Interim_Target_Details = `Interim_target_text`,
    Target_Notes = `Targets_notes`,
    Scope_1 = `Scope_1_coverage`,
    Scope_2 = `Scope_2_coverage`,
    Scope_3 = `Scope_3_coverage`,
    Published_Plan = `Published_plan`,
    Reporting_Method = `Reporting_mechanism`,
    Carbon_Credits = `Carbon_credits`,
    Credit_Conditions = `Carbon_credits_conditions`,
    Emissions = `GHG_emissions`,
    Emissions_Year = `GHG_emissions_year`,
    Pledge_Date = `Date of Carbon Pledge`,
    Net_Zero_Year = `Carbon Neutral or Net Zero by`,
    Revenue = `Company_annual_revenue`,
    Industry = `Industry`,
    Employees = `Employees`,
    Additional_Notes = `Notes`
  )

# Manual corrections
merged_data2 <- merged_data2 %>%
  mutate(Year.y = ifelse(Unique_ID == 18, 2021, Year.y),
         Year.x = ifelse(Year.x == 25, 2025, Year.x),
         End_Target = case_when(
           Unique_ID == 98 & Company.x == "Yum! Brands" ~ "Net zero",
           Unique_ID == 60 & Company.x == "Netflix" ~ "Net zero",
           TRUE ~ End_Target
         ))
```

## 3. Set Treatment and Placebo Variables

```{r treatment}
merged_data2 <- merged_data2 %>%
  filter(!is.na(Avg_Stock_Price)) %>%
  mutate(
    Treated = ifelse(!is.na(Year.y) & Year.y != 0, 1, 0),
    Year.y = ifelse(Treated == 0, NA, Year.y)
  )
```

## 4. Run Staggered DiD Model

```{r Staggered DiD}
staggered_model <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = merged_data2
)
View(merged_data2)

summary(staggered_model)

# 1. Extract and clean terms using your model's actual structure
tidy_yearx <- tidy(staggered_model) %>%
  filter(grepl("Year.x::", term)) %>%
  mutate(
    event_time = gsub("Year.x::(-?\\d+)", "Year \\1", term),
    estimate = sprintf("%.2f", estimate),
    std.error = sprintf("(%.2f)", std.error)
  )

# 2. Reshape to wide format for horizontal display
horizontal_table <- tidy_yearx %>%
  select(event_time, estimate, std.error) %>%
  pivot_longer(cols = c("estimate", "std.error"), names_to = "stat", values_to = "value") %>%
  pivot_wider(names_from = event_time, values_from = value)

# 3. Display as a nicely formatted gt table
gt(horizontal_table) %>%
  tab_header(
    title = "Table 1. Effect of Carbon Neutrality Pledges on Stock Price (Staggered DiD)"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

```

## 5. Visualize Staggered DiD Results

```{r plot-staggered-did}
iplot(
  staggered_model,
  main = "Figure 1: Staggered DiD: Effect on Avg. Stock Price",
  xlab = "Years Since Pledge",
  ylab = "Estimated Effect on Stock Price"
)
```

## 6. Carbon Credits Heterogeniety

```{r carbon-credit-heterogeneity, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}

subset_data <- merged_data2 %>%
  filter((Treated == 1 & Carbon_Credits == "Not Specified") | Treated == 0)

staggered_model <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_data
)

iplot(
  staggered_model,
  main = "Staggered DiD: Not Specified Carbon Credits - Effect on Avg. Stock Price",
  xlab = "Years Since Pledge",
  ylab = "Estimated Effect on Stock Price"
)

# Filter: Treated firms with Carbon Credits == "Yes" OR all untreated firms
subset_yes <- merged_data2 %>%
  filter((Treated == 1 & Carbon_Credits == "Yes") | Treated == 0)

# Run Staggered DiD regression
staggered_model_yes <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_yes
)

# Visualize results
iplot(
  staggered_model_yes,
  main = "Staggered DiD: Carbon Credits = Yes",
  xlab = "Years Since Pledge",
  ylab = "Estimated Effect on Stock Price"
)

# Filter: Treated firms with Carbon Credits == "No" OR all untreated firms
subset_no <- merged_data2 %>%
  filter((Treated == 1 & Carbon_Credits == "No") | Treated == 0)

# Run Staggered DiD regression
staggered_model_no <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_no
)

# Visualize results
iplot(
  staggered_model_no,
  main = "Staggered DiD: Carbon Credits = No",
  xlab = "Years Since Pledge",
  ylab = "Estimated Effect on Stock Price"
)

### One Plot: 

# Helper function to convert iplot to grob
iplot_to_grob <- function(model, main_title) {
  grid.newpage()
  temp <- tempfile(fileext = ".png")
  png(temp, width = 800, height = 600)  # Adjust resolution as needed
  iplot(model, main = main_title, xlab = "Years Since Pledge", ylab = "Effect on Avg. Stock Price")
  dev.off()
  img <- png::readPNG(temp)
  rasterGrob(img, interpolate = TRUE)
}

# Subset and run models
subset_unspecified <- merged_data2 %>% filter((Treated == 1 & Carbon_Credits == "Not Specified") | Treated == 0)
model_unspecified <- feols(Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x, data = subset_unspecified)

subset_yes <- merged_data2 %>% filter((Treated == 1 & Carbon_Credits == "Yes") | Treated == 0)
model_yes <- feols(Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x, data = subset_yes)

subset_no <- merged_data2 %>% filter((Treated == 1 & Carbon_Credits == "No") | Treated == 0)
model_no <- feols(Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x, data = subset_no)

# Convert to grobs
grob_unspecified <- iplot_to_grob(model_unspecified, "Not Specified")
grob_yes <- iplot_to_grob(model_yes, "Yes")
grob_no <- iplot_to_grob(model_no, "No")

# Combine grobs in a list
plot_list <- list(grob_unspecified, grob_yes, grob_no)

# Arrange plots side-by-side with smaller title
grid.arrange(
  grobs = plot_list,
  ncol = 3,
  top = textGrob("Figure 2: Carbon Credit Heterogeneity", gp = gpar(fontsize = 14, fontface = "bold")),
  padding = unit(0.5, "line")
)
###Tabling

# Helper to extract DiD terms
extract_did <- function(model, label) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(
      event_time = gsub("Year.x::(-?\\d+)", "Year \\1", term),
      estimate = round(estimate, 2),
      std.error = round(std.error, 2)
    ) %>%
    select(event_time, estimate, std.error) %>%
    pivot_longer(cols = c(estimate, std.error), names_to = "type", values_to = "value") %>%
    mutate(row_label = ifelse(type == "estimate", label, paste(label, "SE"))) %>%
    select(row_label, event_time, value)
}

# Extract results for each group
not_specified_table <- extract_did(model_unspecified, "Not Specified")
yes_table <- extract_did(model_yes, "Yes")
no_table <- extract_did(model_no, "No")

# Combine all and reshape
combined_table <- bind_rows(not_specified_table, yes_table, no_table) %>%
  pivot_wider(names_from = event_time, values_from = value)

# Create final table
gt(combined_table) %>%
  tab_header(title = "Table 2. Carbon Credit Heterogeneity (Staggered DiD Estimates)") %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

```

## Interm Target
```{r Interm-heterogeneity, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}

# Convert Interim_Target_Year to numeric if it's not already
merged_data2 <- merged_data2 %>%
  mutate(Interim_Target_Year = as.numeric(Interim_Target_Year))

# --- Subset: Treated firms with interim target > 2000 OR untreated firms
subset_interim_target <- merged_data2 %>%
  filter((Treated == 1 & Interim_Target_Year > 2000) | Treated == 0)

# Run Staggered DiD model
staggered_model_interim <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_interim_target
)

# Plot results
iplot(
  staggered_model_interim,
  main = "Staggered DiD: Interim Target vs Control",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

# Filter: Treated firms with Interim_Target_Year < 2000 OR all untreated firms
subset_interim_before_2000 <- merged_data2 %>%
  filter((Treated == 1 & Interim_Target_Year < 2000) | Treated == 0)

# Run the Staggered DiD regression
staggered_model_interim_before_2000 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_interim_before_2000
)

# Plot results
iplot(
  staggered_model_interim_before_2000,
  main = "Staggered DiD: NO Interim Target vs Control",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

##Plotting Together and Tabling

# Make sure Interim_Target_Year is numeric
merged_data2 <- merged_data2 %>%
  mutate(Interim_Target_Year = as.numeric(Interim_Target_Year))

# Subset: Interim Target AFTER 2000 or untreated
subset_after_2000 <- merged_data2 %>%
  filter((Treated == 1 & Interim_Target_Year > 2000) | Treated == 0)

model_after_2000 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_after_2000
)

# Subset: Interim Target BEFORE 2000 or untreated
subset_before_2000 <- merged_data2 %>%
  filter((Treated == 1 & Interim_Target_Year < 2000) | Treated == 0)

model_before_2000 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_before_2000
)

# ---- Plotting (Wrap base plots into grobs) ----
iplot_to_grob <- function(model, title) {
  temp <- tempfile(fileext = ".png")
  png(temp)
  iplot(model, main = title, xlab = "Years Since Pledge", ylab = "Effect on Avg. Stock Price")
  dev.off()
  rasterGrob(png::readPNG(temp), interpolate = TRUE)
}

grob_after <- iplot_to_grob(model_after_2000, "With Interim Target")
grob_before <- iplot_to_grob(model_before_2000, "No Interim Target")

# Arrange both plots side by side
grid.arrange(
  grob_after, grob_before,
  ncol = 2,
  top = textGrob("Figure: Interim Target Heterogeneity", gp = gpar(fontsize = 14, fontface = "bold"))
)

# ---- Table Creation ----
extract_did <- function(model, label) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(
      event_time = gsub("Year.x::(-?\\d+)", "Year \\1", term),
      estimate = round(estimate, 2),
      std.error = round(std.error, 2)
    ) %>%
    select(event_time, estimate, std.error) %>%
    pivot_longer(cols = c(estimate, std.error), names_to = "type", values_to = "value") %>%
    mutate(row_label = ifelse(type == "estimate", label, paste(label, "SE"))) %>%
    select(row_label, event_time, value)
}

table_after <- extract_did(model_after_2000, "Interim Target")
table_before <- extract_did(model_before_2000, "No Interim Target")

combined_table <- bind_rows(table_after, table_before) %>%
  pivot_wider(names_from = event_time, values_from = value)

gt(combined_table) %>%
  tab_header(title = "Table 3: Interim Target Heterogeneity (Staggered DiD Estimates)") %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

```
## Net Zero Complete-By
```{r final-year-heterogeneity, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}

# Ensure Net_Zero_Year is numeric
merged_data2 <- merged_data2 %>%
  mutate(Net_Zero_Year = as.numeric(Net_Zero_Year))

# Filter: Treated firms with Net_Zero_Year <= 2035 OR all untreated firms
subset_netzero_before_2035 <- merged_data2 %>%
  filter((Treated == 1 & Net_Zero_Year <= 2035) | Treated == 0)

# Run the Staggered DiD regression
staggered_model_nz_before_2035 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_netzero_before_2035
)

# Plot results
iplot(
  staggered_model_nz_before_2035,
  main = "Staggered DiD: Net Zero Year ≤ 2035 vs Control",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

# Filter: Treated firms with Net_Zero_Year > 2035 OR all untreated firms
subset_netzero_after_2035 <- merged_data2 %>%
  filter((Treated == 1 & Net_Zero_Year > 2035) | Treated == 0)

# Run the Staggered DiD regression
staggered_model_nz_after_2035 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_netzero_after_2035
)

# Plot results
iplot(
  staggered_model_nz_after_2035,
  main = "Staggered DiD: Net Zero Year > 2035 vs Control",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

### Plotting Side by Side
# Helper: Wrap iplot into grob for grid.arrange
iplot_to_grob <- function(model, main_title) {
  grid.newpage()
  temp <- tempfile(fileext = ".png")
  png(temp)
  iplot(model, main = main_title, xlab = "Years Since Pledge", ylab = "Effect on Avg. Stock Price")
  dev.off()
  img <- png::readPNG(temp)
  rasterGrob(img, interpolate = TRUE)
}

# Create grobs
grob_nz_before <- iplot_to_grob(staggered_model_nz_before_2035, "Net Zero Year ≤ 2035")
grob_nz_after  <- iplot_to_grob(staggered_model_nz_after_2035,  "Net Zero Year > 2035")

# Plot side-by-side
gridExtra::grid.arrange(
  grob_nz_before, grob_nz_after,
  ncol = 2,
  top = grid::textGrob("Figure: Net Zero Target Year Heterogeneity", gp = gpar(fontsize = 14, fontface = "bold"))
)
##Tabling
# Helper to extract and format
extract_did <- function(model, label) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(
      event_time = gsub("Year.x::(-?\\d+)", "Year \\1", term),
      estimate = sprintf("%.2f", estimate),
      std.error = sprintf("%.2f", std.error)
    ) %>%
    select(event_time, estimate, std.error) %>%
    pivot_longer(cols = c("estimate", "std.error"), names_to = "stat", values_to = "value") %>%
    mutate(row_label = ifelse(stat == "estimate", label, paste(label, "SE"))) %>%
    select(row_label, event_time, value)
}

# Extract
table_nz_before <- extract_did(staggered_model_nz_before_2035, "Net Zero ≤ 2035")
table_nz_after  <- extract_did(staggered_model_nz_after_2035,  "Net Zero > 2035")

# Combine and reshape
combined_table <- bind_rows(table_nz_before, table_nz_after) %>%
  pivot_wider(names_from = event_time, values_from = value)

# Display
gt(combined_table) %>%
  tab_header(title = "Table 4: Net Zero Target Year Heterogeneity (Staggered DiD Estimates)") %>%
  tab_style(style = cell_text(weight = "bold"),
            locations = cells_column_labels(everything()))

```

## Accountability Heterogeniety
```{r Accountability-heterogeneity, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}

# --- Not Specified Group ---
subset_acc_unspecified <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Not Specified") | Treated == 0)

staggered_model_unspecified <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_acc_unspecified
)

iplot(
  staggered_model_unspecified,
  main = "Staggered DiD: Accountability = Not Specified",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

# --- Yes Group ---
subset_acc_yes <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Yes") | Treated == 0)

staggered_model_yes <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_acc_yes
)

iplot(
  staggered_model_yes,
  main = "Staggered DiD: Accountability = Yes",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

# --- No Group ---
subset_acc_no <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "No") | Treated == 0)

staggered_model_no <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_acc_no
)

iplot(
  staggered_model_no,
  main = "Staggered DiD: Accountability = No",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)
## Plotting Side by Side

#--- Helper to create grob from iplot
iplot_to_grob <- function(model, title) {
  temp <- tempfile(fileext = ".png")
  png(temp, width = 800, height = 600)
  iplot(model, main = title, xlab = "Years Since Pledge", ylab = "Effect on Stock Price")
  dev.off()
  img <- png::readPNG(temp)
  rasterGrob(img, interpolate = TRUE)
}

#--- Not Specified Group
subset_unspecified <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Not Specified") | Treated == 0)

model_unspecified <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_unspecified
)

grob_unspecified <- iplot_to_grob(model_unspecified, "Accountability: Not Specified")

#--- Yes Group
subset_yes <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Yes") | Treated == 0)

model_yes <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_yes
)

grob_yes <- iplot_to_grob(model_yes, "Accountability: Yes")

#--- No Group
subset_no <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "No") | Treated == 0)

model_no <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_no
)

grob_no <- iplot_to_grob(model_no, "Accountability: No")

#--- Combine Plots Side by Side
grid.arrange(
  grob_unspecified, grob_yes, grob_no,
  ncol = 3,
  top = textGrob("Figure: Accountability Delivery Heterogeneity", gp = gpar(fontsize = 14, fontface = "bold"))
)
## Tabling
# Extract and prepare results
tidy_group <- function(model, label) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(
      group = label,
      event_time = gsub("Year.x::", "Year ", term),
      estimate = sprintf("%.2f", estimate),
      std.error = sprintf("(%.2f)", std.error)
    ) %>%
    select(group, event_time, estimate, std.error)
}

results_combined <- bind_rows(
  tidy_group(model_unspecified, "Not Specified"),
  tidy_group(model_yes, "Yes"),
  tidy_group(model_no, "No")
)

# Stack estimates and SEs as rows
results_long <- results_combined %>%
  pivot_longer(cols = c(estimate, std.error), names_to = "stat", values_to = "value") %>%
  mutate(label = ifelse(stat == "estimate", group, paste0(group, " (SE)"))) %>%
  select(label, event_time, value) %>%
  pivot_wider(names_from = event_time, values_from = value)

# Display the table
gt(results_long) %>%
  tab_header(title = "Table: Stock Price Impact by Accountability Delivery") %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

```
