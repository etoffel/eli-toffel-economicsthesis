---
title: "Staggered DiD: Carbon Pledge Impact on Stock Price"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

## 1. Load Data and Preprocessing

```{r load-data}
source("housekeeping.R")

carbon_neutral <- read_csv("data/Build 2/Carbon Neutral Pledging Data.csv")
stock_data <- read_csv("data/Build 2/Stock Data.csv")
revenue_data <- read_csv("data/Build 2/Revenue Data.csv")
View()
# Fix Unique ID for Burger King
stock_data <- stock_data %>% mutate(`Unique ID` = ifelse(Company == "Burger King", 69, `Unique ID`))
revenue_data <- revenue_data %>% mutate(`Unique ID` = ifelse(Company == "Burger King", 69, `Unique ID`))
```

## 2. Merge and Clean Data
```{r merge-clean}
merged_data2 <- stock_data %>% left_join(carbon_neutral, by = "Unique ID")

merged_data2 <- merged_data2 %>%
  rename(
    Unique_ID = `Unique ID`,
    Avg_Stock_Price = `Average Stock Price`,
    Year_Open = `Year Open`,
    Year_High = `Year High`,
    Year_Low = `Year Low`,
    Year_Close = `Year Close`,
    Annual_Change = `Annual % Change`,
    End_Target = `End Target`,
    Target_Reduction = `End_target_percentage_reduction`,
    Target_Baseline_Year = `End_target_baseline_year2`,
    Target_Completion_Year = `End_target_year`,
    Target_Status = `Status_of_end_target`,
    Last_Update = `Date_of_last_status_update`,
    Target_Details = `End_target_text`,
    Interim_Target = `Interim_target`,
    Interim_Target_Year = `Interim_target_year`,
    Interim_Target_Reduction = `Interim_target_percentage_reduction`,
    Interim_Target_Baseline = `Interim_target_baseline_year`,
    Interim_Target_Details = `Interim_target_text`,
    Target_Notes = `Targets_notes`,
    Scope_1 = `Scope_1_coverage`,
    Scope_2 = `Scope_2_coverage`,
    Scope_3 = `Scope_3_coverage`,
    Published_Plan = `Published_plan`,
    Reporting_Method = `Reporting_mechanism`,
    Carbon_Credits = `Carbon_credits`,
    Credit_Conditions = `Carbon_credits_conditions`,
    Emissions = `GHG_emissions`,
    Emissions_Year = `GHG_emissions_year`,
    Pledge_Date = `Date of Carbon Pledge`,
    Net_Zero_Year = `Carbon Neutral or Net Zero by`,
    Revenue = `Company_annual_revenue`,
    Industry = `Industry`,
    Employees = `Employees`,
    Additional_Notes = `Notes`
  )

# Manual corrections
merged_data2 <- merged_data2 %>%
  mutate(Year.y = ifelse(Unique_ID == 18, 2021, Year.y),
         Year.x = ifelse(Year.x == 25, 2025, Year.x),
         End_Target = case_when(
           Unique_ID == 98 & Company.x == "Yum! Brands" ~ "Net zero",
           Unique_ID == 60 & Company.x == "Netflix" ~ "Net zero",
           TRUE ~ End_Target
         ))
```

## 3. Set Treatment and Placebo Variables

```{r treatment}
merged_data2 <- merged_data2 %>%
  filter(!is.na(Avg_Stock_Price)) %>%
  mutate(
    Treated = ifelse(!is.na(Year.y) & Year.y != 0, 1, 0),
    Year.y = ifelse(Treated == 0, NA, Year.y)
  )
```
View(merged_data2)

## 4. Run Staggered DiD Model

```{r Staggered DiD}

# Estimate model
staggered_model <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = merged_data2
)

# View results
summary(staggered_model)

# 1. Extract and clean yearly terms
tidy_yearx <- tidy(staggered_model) %>%
  filter(grepl("Year.x::", term)) %>%
  mutate(
    event_time = as.numeric(gsub("Year.x::", "", term)),
    year_label = paste0("Year ", event_time),
    estimate = round(estimate, 2),
    std.error = round(std.error, 2)
  )

# 2. Weighted average DiD estimate (for post-treatment years only)
att_avg <- tidy_yearx %>%
  filter(event_time >= 0) %>%
  summarize(
    weighted_avg_ATT = round(weighted.mean(estimate, w = 1 / (std.error^2)), 2)
  )

# 3. Prepare wide-format table
horizontal_table <- tidy_yearx %>%
  mutate(
    estimate_str = sprintf("%.2f", estimate),
    std_error_str = sprintf("(%.2f)", std.error)
  ) %>%
  select(year_label, estimate_str, std_error_str) %>%
  pivot_longer(cols = c("estimate_str", "std_error_str"), names_to = "stat", values_to = "value") %>%
  mutate(label = ifelse(stat == "estimate_str", "Estimate", "SE")) %>%
  select(label, year_label, value) %>%
  pivot_wider(names_from = year_label, values_from = value)

# 4. Display table
gt(horizontal_table) %>%
  tab_header(
    title = md("**Table 1. Staggered DiD: Carbon Neutrality Pledges on Stock Price**"),
    subtitle = paste("Weighted Avg Post-Treatment ATT:", att_avg$weighted_avg_ATT)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

```

## 5. Visualize Staggered DiD Results

```{r plot-staggered-did-trimmed}
# Get range of event times from the model
event_times <- as.numeric(gsub("Year.x::", "", names(coef(staggered_model))))
# Filter to include only from min to 4 (exclude Year 5 & 6)
included_years <- event_times[event_times <= 4]

iplot(
  staggered_model,
  main = "Figure 1: Staggered DiD: Effect on Avg. Stock Price",
  xlab = "Years Since Pledge",
  ylab = "Estimated Effect on Stock Price",
  xlim = range(included_years)  # trim to Year -X to 4
)

```

## 6. Carbon Credits Heterogeniety

```{r carbon-credit-heterogeneity-panelplot, fig.width=10, fig.height=4, warning=FALSE, message=FALSE}

# Function to extract DiD estimates
extract_event_study <- function(model, group_label, color) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(
      event_time = as.integer(gsub("Year.x::", "", term)),
      group = group_label,
      color = color
    ) %>%
    filter(!event_time %in% c(-6, -5, 4))  # Drop specified years
}

# Colors
colors <- c("Not Specified" = "#999999", "Yes" = "#fc8d62", "No" = "#66c2a5")

# --- Run models ---
model_unspecified <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = merged_data2 %>% filter((Treated == 1 & Carbon_Credits == "Not Specified") | Treated == 0)
)

model_yes <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = merged_data2 %>% filter((Treated == 1 & Carbon_Credits == "Yes") | Treated == 0)
)

model_no <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = merged_data2 %>% filter((Treated == 1 & Carbon_Credits == "No") | Treated == 0)
)

# --- Extract results ---
df_unspecified <- extract_event_study(model_unspecified, "Not Specified", colors["Not Specified"])
df_yes         <- extract_event_study(model_yes,         "Yes",           colors["Yes"])
df_no          <- extract_event_study(model_no,          "No",            colors["No"])

# Combine all
all_data <- bind_rows(df_unspecified, df_yes, df_no)

# --- Create plot function (No vertical line) ---
plot_group <- function(data, group_label) {
  ggplot(data %>% filter(group == group_label), aes(x = event_time, y = estimate)) +
    geom_point(color = colors[group_label], size = 2) +
    geom_errorbar(aes(ymin = estimate - 1.96 * std.error,
                      ymax = estimate + 1.96 * std.error),
                  width = 0.2, color = colors[group_label]) +
    geom_hline(yintercept = 0, color = "black") +
    labs(title = paste("Carbon Credits =", group_label),
         x = "Years Since Pledge",
         y = "Estimated Effect on Stock Price") +
    theme_minimal(base_size = 11) +
    ylim(min(all_data$estimate - 1.96 * all_data$std.error),
         max(all_data$estimate + 1.96 * all_data$std.error))
}


# Generate individual plots
plot1 <- plot_group(all_data, "Not Specified")
plot2 <- plot_group(all_data, "Yes")
plot3 <- plot_group(all_data, "No")

# Combine all in one figure
grid.arrange(plot1, plot2, plot3, ncol = 3,
             top = textGrob("Figure 2: Stock Price Response by Carbon Credit Group",
                            gp = gpar(fontsize = 14, fontface = "bold")))
```

## Interm Target
```{r Interm-heterogeneity, fig.width=10, fig.height=5, warning=FALSE, message=FALSE}

# Ensure Interim_Target_Year is numeric
merged_data2 <- merged_data2 %>%
  mutate(Interim_Target_Year = as.numeric(Interim_Target_Year))

# Subset: Interim Target > 2000 or untreated
subset_after_2000 <- merged_data2 %>%
  filter((Treated == 1 & Interim_Target_Year > 2000) | Treated == 0)

# Subset: Interim Target < 2000 or untreated
subset_before_2000 <- merged_data2 %>%
  filter((Treated == 1 & Interim_Target_Year < 2000) | Treated == 0)

# Run models
model_after_2000 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_after_2000
)

model_before_2000 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_before_2000
)

# ---- Shared y-axis range ----
all_ci_vals <- c(confint(model_after_2000)[, 1:2], confint(model_before_2000)[, 1:2])
y_range <- range(all_ci_vals)

# ---- Helper to plot with style ----
iplot_to_grob <- function(model, main_title, col = "black", col.border = "black", ylim_range = NULL) {
  temp <- tempfile(fileext = ".png")
  png(temp, width = 800, height = 600)

  event_times <- as.numeric(gsub("Year.x::", "", names(coef(model))))
  xlim_range <- range(event_times[!event_times %in% c(-6, 5, 6)])

  iplot(model,
        main = main_title,
        xlab = "Years Since Pledge",
        ylab = "Estimated Effect on Stock Price",
        col = col,
        col.border = col.border,
        ref.line = FALSE,
        xlim = xlim_range,
        ylim = ylim_range,
        cex = 2.5,      # Bigger dots
        lwd = 2.5)    # Thicker lines
  
  dev.off()
  img <- png::readPNG(temp)
  grid::rasterGrob(img, interpolate = TRUE)
}



# Colors
sky_blue <- "#87CEEB"
bubblegum_pink <- "#FF69B4"

# Create styled plots
grob_after <- iplot_to_grob(model_after_2000, "With Interim Target", sky_blue, sky_blue, y_range)
grob_before <- iplot_to_grob(model_before_2000, "No Interim Target", bubblegum_pink, bubblegum_pink, y_range)

# Arrange plots side by side
grid.arrange(
  grob_after, grob_before,
  ncol = 2,
  top = textGrob("Figure: Interim Target Heterogeneity", gp = gpar(fontsize = 14, fontface = "bold"))
)

# --- Helper: Extract and reshape DiD estimates ---
extract_did_interim <- function(model, label) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(
      event_time = gsub("Year.x::", "Year ", term),
      estimate = sprintf("%.2f", estimate),
      std.error = sprintf("(%.2f)", std.error)
    ) %>%
    select(event_time, estimate, std.error) %>%
    pivot_longer(cols = c("estimate", std.error), names_to = "stat", values_to = "value") %>%
    mutate(row_label = ifelse(stat == "estimate", label, paste(label, "SE"))) %>%
    select(row_label, event_time, value)
}

# Extract results for both groups
table_after_2000  <- extract_did_interim(model_after_2000, "Interim Target")
table_before_2000 <- extract_did_interim(model_before_2000, "No Interim Target")

# Combine and reshape to wide format
interim_combined_table <- bind_rows(table_after_2000, table_before_2000) %>%
  pivot_wider(names_from = event_time, values_from = value)

# Display as gt table
gt(interim_combined_table) %>%
  tab_header(title = "Table: Stock Price Impact by Interim Target Year") %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

```




## Net Zero Complete-By
```{r final-year-heterogeneity, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}

# Ensure Net_Zero_Year is numeric
merged_data2 <- merged_data2 %>%
  mutate(Net_Zero_Year = as.numeric(Net_Zero_Year))

# Filter: Treated firms with Net_Zero_Year <= 2035 OR all untreated firms
subset_netzero_before_2035 <- merged_data2 %>%
  filter((Treated == 1 & Net_Zero_Year <= 2035) | Treated == 0)

# Run the Staggered DiD regression
staggered_model_nz_before_2035 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_netzero_before_2035
)

# Plot results
iplot(
  staggered_model_nz_before_2035,
  main = "Staggered DiD: Net Zero Year ≤ 2035 vs Control",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

# Filter: Treated firms with Net_Zero_Year > 2035 OR all untreated firms
subset_netzero_after_2035 <- merged_data2 %>%
  filter((Treated == 1 & Net_Zero_Year > 2035) | Treated == 0)

# Run the Staggered DiD regression
staggered_model_nz_after_2035 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_netzero_after_2035
)

# Plot results
iplot(
  staggered_model_nz_after_2035,
  main = "Staggered DiD: Net Zero Year > 2035 vs Control",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

### Plotting Side by Side
# Helper: Wrap iplot into grob for grid.arrange
iplot_to_grob <- function(model, main_title) {
  grid.newpage()
  temp <- tempfile(fileext = ".png")
  png(temp)
  iplot(model, main = main_title, xlab = "Years Since Pledge", ylab = "Effect on Avg. Stock Price")
  dev.off()
  img <- png::readPNG(temp)
  rasterGrob(img, interpolate = TRUE)
}

# Create grobs
grob_nz_before <- iplot_to_grob(staggered_model_nz_before_2035, "Net Zero Year ≤ 2035")
grob_nz_after  <- iplot_to_grob(staggered_model_nz_after_2035,  "Net Zero Year > 2035")

# Plot side-by-side
gridExtra::grid.arrange(
  grob_nz_before, grob_nz_after,
  ncol = 2,
  top = grid::textGrob("Figure: Net Zero Target Year Heterogeneity", gp = gpar(fontsize = 14, fontface = "bold"))
)
##Tabling
# Helper to extract and format
extract_did <- function(model, label) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(
      event_time = gsub("Year.x::(-?\\d+)", "Year \\1", term),
      estimate = sprintf("%.2f", estimate),
      std.error = sprintf("%.2f", std.error)
    ) %>%
    select(event_time, estimate, std.error) %>%
    pivot_longer(cols = c("estimate", "std.error"), names_to = "stat", values_to = "value") %>%
    mutate(row_label = ifelse(stat == "estimate", label, paste(label, "SE"))) %>%
    select(row_label, event_time, value)
}

# Extract
table_nz_before <- extract_did(staggered_model_nz_before_2035, "Net Zero ≤ 2035")
table_nz_after  <- extract_did(staggered_model_nz_after_2035,  "Net Zero > 2035")

# Combine and reshape
combined_table <- bind_rows(table_nz_before, table_nz_after) %>%
  pivot_wider(names_from = event_time, values_from = value)

# Display
gt(combined_table) %>%
  tab_header(title = "Table 4: Net Zero Target Year Heterogeneity (Staggered DiD Estimates)") %>%
  tab_style(style = cell_text(weight = "bold"),
            locations = cells_column_labels(everything()))

```

## Accountability Heterogeniety
```{r Accountability-heterogeneity, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}

# --- Not Specified Group ---
subset_acc_unspecified <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Not Specified") | Treated == 0)

staggered_model_unspecified <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_acc_unspecified
)

iplot(
  staggered_model_unspecified,
  main = "Staggered DiD: Accountability = Not Specified",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

# --- Yes Group ---
subset_acc_yes <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Yes") | Treated == 0)

staggered_model_yes <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_acc_yes
)

iplot(
  staggered_model_yes,
  main = "Staggered DiD: Accountability = Yes",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

# --- No Group ---
subset_acc_no <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "No") | Treated == 0)

staggered_model_no <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_acc_no
)

iplot(
  staggered_model_no,
  main = "Staggered DiD: Accountability = No",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)
## Plotting Side by Side

#--- Helper to create grob from iplot
iplot_to_grob <- function(model, title) {
  temp <- tempfile(fileext = ".png")
  png(temp, width = 800, height = 600)
  iplot(model, main = title, xlab = "Years Since Pledge", ylab = "Effect on Stock Price")
  dev.off()
  img <- png::readPNG(temp)
  rasterGrob(img, interpolate = TRUE)
}

#--- Not Specified Group
subset_unspecified <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Not Specified") | Treated == 0)

model_unspecified <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_unspecified
)

grob_unspecified <- iplot_to_grob(model_unspecified, "Accountability: Not Specified")

#--- Yes Group
subset_yes <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Yes") | Treated == 0)

model_yes <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_yes
)

grob_yes <- iplot_to_grob(model_yes, "Accountability: Yes")

#--- No Group
subset_no <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "No") | Treated == 0)

model_no <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_no
)

grob_no <- iplot_to_grob(model_no, "Accountability: No")

#--- Combine Plots Side by Side
grid.arrange(
  grob_unspecified, grob_yes, grob_no,
  ncol = 3,
  top = textGrob("Figure: Accountability Delivery Heterogeneity", gp = gpar(fontsize = 14, fontface = "bold"))
)
## Tabling
# Extract and prepare results
tidy_group <- function(model, label) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(
      group = label,
      event_time = gsub("Year.x::", "Year ", term),
      estimate = sprintf("%.2f", estimate),
      std.error = sprintf("(%.2f)", std.error)
    ) %>%
    select(group, event_time, estimate, std.error)
}

results_combined <- bind_rows(
  tidy_group(model_unspecified, "Not Specified"),
  tidy_group(model_yes, "Yes"),
  tidy_group(model_no, "No")
)

# Stack estimates and SEs as rows
results_long <- results_combined %>%
  pivot_longer(cols = c(estimate, std.error), names_to = "stat", values_to = "value") %>%
  mutate(label = ifelse(stat == "estimate", group, paste0(group, " (SE)"))) %>%
  select(label, event_time, value) %>%
  pivot_wider(names_from = event_time, values_from = value)

# Display the table
gt(results_long) %>%
  tab_header(title = "Table: Stock Price Impact by Accountability Delivery") %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

```
