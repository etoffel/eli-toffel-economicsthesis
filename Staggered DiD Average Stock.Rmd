---
title: "Staggered DiD: Carbon Pledge Impact on Stock Price"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

## 1. Load Data and Preprocessing

```{r load-data}
source("housekeeping.R")

carbon_neutral <- read_csv("data/Build 2/Carbon Neutral Pledging Data.csv")
stock_data <- read_csv("data/Build 2/Stock Data.csv")

# Fix Unique ID for Burger King
stock_data <- stock_data %>% mutate(`Unique ID` = ifelse(Company == "Burger King", 69, `Unique ID`))
revenue_data <- revenue_data %>% mutate(`Unique ID` = ifelse(Company == "Burger King", 69, `Unique ID`))
```

## 2. Merge and Clean Data
```{r merge-clean}
merged_data2 <- stock_data %>% left_join(carbon_neutral, by = "Unique ID")

merged_data2 <- merged_data2 %>%
  rename(
    Unique_ID = `Unique ID`,
    Avg_Stock_Price = `Average Stock Price`,
    Year_Open = `Year Open`,
    Year_High = `Year High`,
    Year_Low = `Year Low`,
    Year_Close = `Year Close`,
    Annual_Change = `Annual % Change`,
    End_Target = `End Target`,
    Target_Reduction = `End_target_percentage_reduction`,
    Target_Baseline_Year = `End_target_baseline_year2`,
    Target_Completion_Year = `End_target_year`,
    Target_Status = `Status_of_end_target`,
    Last_Update = `Date_of_last_status_update`,
    Target_Details = `End_target_text`,
    Interim_Target = `Interim_target`,
    Interim_Target_Year = `Interim_target_year`,
    Interim_Target_Reduction = `Interim_target_percentage_reduction`,
    Interim_Target_Baseline = `Interim_target_baseline_year`,
    Interim_Target_Details = `Interim_target_text`,
    Target_Notes = `Targets_notes`,
    Scope_1 = `Scope_1_coverage`,
    Scope_2 = `Scope_2_coverage`,
    Scope_3 = `Scope_3_coverage`,
    Published_Plan = `Published_plan`,
    Reporting_Method = `Reporting_mechanism`,
    Carbon_Credits = `Carbon_credits`,
    Credit_Conditions = `Carbon_credits_conditions`,
    Emissions = `GHG_emissions`,
    Emissions_Year = `GHG_emissions_year`,
    Pledge_Date = `Date of Carbon Pledge`,
    Net_Zero_Year = `Carbon Neutral or Net Zero by`,
    Revenue = `Company_annual_revenue`,
    Industry = `Industry`,
    Employees = `Employees`,
    Additional_Notes = `Notes`
  )

# Manual corrections
merged_data2 <- merged_data2 %>%
  mutate(Year.y = ifelse(Unique_ID == 18, 2021, Year.y),
         Year.x = ifelse(Year.x == 25, 2025, Year.x),
         End_Target = case_when(
           Unique_ID == 98 & Company.x == "Yum! Brands" ~ "Net zero",
           Unique_ID == 60 & Company.x == "Netflix" ~ "Net zero",
           TRUE ~ End_Target
         ))

### T-Mobile Fix
# Define the column range to shift
cols_to_shift <- 12:46

# Identify T-Mobile rows
rows_to_shift <- !is.na(merged_data2$Company.y) & merged_data2$Company.y == "T-Mobile"

# Convert affected columns to character just for assignment safety
merged_data2[cols_to_shift] <- lapply(merged_data2[cols_to_shift], as.character)

# Create a shifted version of the relevant slice
shift_matrix <- merged_data2[rows_to_shift, cols_to_shift]

# Shift left: assign col 2:n to col 1:(n-1)
shift_matrix[, -length(cols_to_shift)] <- shift_matrix[, -1]
shift_matrix[, length(cols_to_shift)] <- NA  # Fill last col with NA

# Assign the shifted matrix back
merged_data2[rows_to_shift, cols_to_shift] <- shift_matrix
```

## 3. Set Treatment and Placebo Variables

```{r treatment}
merged_data2 <- merged_data2 %>%
  filter(!is.na(Avg_Stock_Price)) %>%
  mutate(
    Treated = ifelse(!is.na(Year.y) & Year.y != 0, 1, 0),
    Year.y = ifelse(Treated == 0, NA, Year.y)
  )
```

```{r Updated Count Table}
# Step 1: Select one row per firm (e.g., first year available)
single_obs <- merged_data2 %>%
  arrange(Unique_ID, Year.x) %>%
  group_by(Unique_ID) %>%
  slice(1) %>%
  ungroup()

View(single_obs)

# Step 2: Define treatment/control target types
treatment_targets <- c("Net zero", "Carbon neutral(ity)", "Climate neutral", 
                       "Carbon negative", "Zero emissions")
control_targets <- c("Emissions reduction target", "No target")
target_order <- c(
  "Net zero", 
  "Carbon neutral(ity)", 
  "Climate neutral", 
  "Carbon negative", 
  "Zero emissions", 
  "Emissions reduction target", 
  "No target"
)

# Step 3: Count and categorize targets from this one-row-per-firm dataset
table_data <- single_obs %>%
  count(End_Target) %>%
  mutate(
    Group = case_when(
      End_Target %in% treatment_targets ~ "Treatment",
      End_Target %in% control_targets ~ "Control",
      TRUE ~ "Other"
    ),
    End_Target = factor(End_Target, levels = target_order)
  ) %>%
  filter(!is.na(End_Target)) %>%
  arrange(End_Target)
# Build the gt table
table_data %>%
  gt() %>%
  cols_label(
    End_Target = "End Target",
    n = "Count"
  ) %>%
  tab_header(
    title = "Table 2: Public Companies' Carbon Targets",
    subtitle = "Grouped and ordered by treatment/control classification"
  ) %>%
  fmt_number(
    columns = c(n),
    decimals = 0
  ) %>%
  tab_style(
    style = cell_fill(color = "#e0f7fa"),
    locations = cells_body(
      rows = Group == "Treatment"
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#f1f8e9"),
    locations = cells_body(
      rows = Group == "Control"
    )
  ) %>%
  grand_summary_rows(
    columns = c(n),
    fns = list(Total = ~sum(n)),
    formatter = fmt_number,
    decimals = 0
  )
View(merged_data2)
```

```{r Summary Stats}

# Step 1: Build treated_summary
treated_summary <- merged_data2 %>%
  filter(Treated == 1) %>%                         # Only treated firms
  arrange(Unique_ID, Year.x) %>%                    # Sort by Unique_ID and year
  group_by(Unique_ID) %>%
  slice(1) %>%                                      # Only first row per firm
  ungroup() %>%
  mutate(
    Has_Interim_Target = ifelse(!is.na(Interim_Target_Year) & Interim_Target_Year != 0, "Yes", "No"), # Handle interim properly
    Carbon_Credits = case_when(
      Carbon_Credits %in% c("Yes", "No") ~ Carbon_Credits,
      TRUE ~ "Not Specified"
    )
  ) %>%
  group_by(Carbon_Credits, Has_Interim_Target) %>%
  summarize(
    Firms = n(),                                      # Firm count
    `Avg Pledge Year` = round(mean(Year.y, na.rm = TRUE)),  # Avg Pledge Year (Year.y)
    `Avg Net Zero Year` = round(mean(Net_Zero_Year, na.rm = TRUE)), # Avg Completion
    .groups = "drop"
  )

# Step 2: Build the gt table
treated_summary %>%
  gt() %>%
  tab_header(
    title = "Table 3: Treated Firms Summary Statistics",
    subtitle = "Carbon Credits, Target Years, and Interim Years"
  ) %>%
  cols_label(
    Carbon_Credits = "Carbon Credits",
    Firms = "Firms",
    Has_Interim_Target = "Has Interim Target?",
    `Avg Pledge Year` = "Avg Pledge Year",
    `Avg Net Zero Year` = "Avg Completion Date"
  ) %>%
  cols_move(columns = Firms, after = Carbon_Credits) %>%
  cols_move(columns = Has_Interim_Target, after = Firms) %>%
  fmt_number(
    columns = c(`Avg Pledge Year`, `Avg Net Zero Year`),
    decimals = 0,
    use_seps = FALSE
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  ) %>%
  tab_style(
    style = list(cell_fill(color = "#E0E0E0")),
    locations = cells_body(rows = Carbon_Credits == "Not Specified")
  ) %>%
  tab_style(
    style = list(cell_fill(color = "#B2DFDB")),
    locations = cells_body(rows = Carbon_Credits == "No")
  ) %>%
  tab_style(
    style = list(cell_fill(color = "#FFCCBC")),
    locations = cells_body(rows = Carbon_Credits == "Yes")
  )

```

View(merged_data2)

## 4. Run Staggered DiD Model
```{r Staggered DiD}

# Estimate model
staggered_model <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = merged_data2
)

# View results
summary(staggered_model)

# 1. Extract and clean yearly terms
tidy_yearx <- tidy(staggered_model) %>%
  filter(grepl("Year.x::", term)) %>%
  mutate(
    event_time = as.numeric(gsub("Year.x::", "", term)),
    year_label = paste0("Year ", event_time),
    estimate = round(estimate, 2),
    std.error = round(std.error, 2)
  )

# 2. Weighted average DiD estimate (for post-treatment years only)
att_avg <- tidy_yearx %>%
  filter(event_time >= 0) %>%
  summarize(
    weighted_avg_ATT = round(weighted.mean(estimate, w = 1 / (std.error^2)), 2)
  )

# 3. Prepare wide-format table
horizontal_table <- tidy_yearx %>%
  mutate(
    estimate_str = sprintf("%.2f", estimate),
    std_error_str = sprintf("(%.2f)", std.error)
  ) %>%
  select(year_label, estimate_str, std_error_str) %>%
  pivot_longer(cols = c("estimate_str", "std_error_str"), names_to = "stat", values_to = "value") %>%
  mutate(label = ifelse(stat == "estimate_str", "Estimate", "SE")) %>%
  select(label, year_label, value) %>%
  pivot_wider(names_from = year_label, values_from = value)

# 4. Display table
gt(horizontal_table) %>%
  tab_header(
    title = md("**Table 4. Staggered DiD: Carbon Neutrality Pledges on Stock Price**"),
    subtitle = paste("Weighted Avg Post-Treatment ATT:", att_avg$weighted_avg_ATT)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

```

## 5. Visualize Staggered DiD Results

```{r plot-staggered-did-trimmed}
# Get range of event times from the model
event_times <- as.numeric(gsub("Year.x::", "", names(coef(staggered_model))))
# Filter to include only from min to 4 (exclude Year 5 & 6)
included_years <- event_times[event_times <= 4]

iplot(
  staggered_model,
  main = "Figure 1: Staggered DiD: Effect on Avg. Stock Price",
  xlab = "Years Since Pledge",
  ylab = "Estimated Effect on Stock Price",
  xlim = range(included_years)  # trim to Year -X to 4
)

```

## 6. Carbon Credits Heterogeniety

```{r carbon-credit-heterogeneity-panelplot, fig.width=10, fig.height=4, warning=FALSE, message=FALSE}

# Function to extract DiD estimates
extract_event_study <- function(model, group_label, color) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(
      event_time = as.integer(gsub("Year.x::", "", term)),
      group = group_label,
      color = color
    ) %>%
    filter(!event_time %in% c(-6, -5, 4))  # Drop specified years
}

# Colors
colors <- c("Not Specified" = "#999999", "Yes" = "#fc8d62", "No" = "#66c2a5")

# --- Run models ---
model_unspecified <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = merged_data2 %>% filter((Treated == 1 & Carbon_Credits == "Not Specified") | Treated == 0)
)

model_yes <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = merged_data2 %>% filter((Treated == 1 & Carbon_Credits == "Yes") | Treated == 0)
)

model_no <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = merged_data2 %>% filter((Treated == 1 & Carbon_Credits == "No") | Treated == 0)
)

# --- Extract results ---
df_unspecified <- extract_event_study(model_unspecified, "Not Specified", colors["Not Specified"])
df_yes         <- extract_event_study(model_yes,         "Yes",           colors["Yes"])
df_no          <- extract_event_study(model_no,          "No",            colors["No"])

# Combine all
all_data <- bind_rows(df_unspecified, df_yes, df_no)

# --- Create plot function (No vertical line) ---
plot_group <- function(data, group_label) {
  ggplot(data %>% filter(group == group_label), aes(x = event_time, y = estimate)) +
    geom_point(color = colors[group_label], size = 2) +
    geom_errorbar(aes(ymin = estimate - 1.96 * std.error,
                      ymax = estimate + 1.96 * std.error),
                  width = 0.2, color = colors[group_label]) +
    geom_hline(yintercept = 0, color = "black") +
    labs(title = paste("Carbon Credits =", group_label),
         x = "Years Since Pledge",
         y = "Estimated Effect on Stock Price") +
    theme_minimal(base_size = 11) +
    ylim(min(all_data$estimate - 1.96 * all_data$std.error),
         max(all_data$estimate + 1.96 * all_data$std.error))
}


# Generate individual plots
plot1 <- plot_group(all_data, "Not Specified")
plot2 <- plot_group(all_data, "Yes")
plot3 <- plot_group(all_data, "No")

# Combine all in one figure
grid.arrange(plot1, plot2, plot3, ncol = 3,
             top = textGrob("Figure 2: Stock Price Response by Carbon Credit Group",
                            gp = gpar(fontsize = 14, fontface = "bold")))

# Filter to post-treatment years only (event_time >= 0)
carbon_table <- all_data %>%
  filter(event_time >= 0) %>%
  mutate(
    Year = paste0("Year ", event_time),
    Estimate = sprintf("%.2f", estimate),
    SE = sprintf("(%.2f)", std.error)
  ) %>%
  select(Group = group, Year, Estimate, SE)

# Display with gt
gt(carbon_table) %>%
  tab_header(
    title = md("**Table 5. Stock Price Effects by Carbon Credit Group**"),
    subtitle = "Post-Treatment Estimates Only (Years ≥ 0)"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

# Define lighter color mapping
colors <- c(
  "Not Specified" = "#d3d3d3",  # light gray
  "Yes" = "#fddbc7",            # light orange
  "No" = "#d1eeea"              # light turquoise
)

group_levels <- c("Not Specified", "Yes", "No")

# Prepare data
carbon_table <- all_data %>%
  filter(event_time >= 0) %>%
  mutate(
    Group = factor(group, levels = group_levels),
    Year = as.character(event_time),
    Estimate = sprintf("%.2f", estimate),
    SE = sprintf("(%.2f)", std.error)
  ) %>%
  select(Group, Year, Estimate, SE) %>%
  arrange(Group, as.numeric(Year)) %>%
  group_by(Group) %>%
  mutate(Group = ifelse(row_number() == 1, as.character(Group), "")) %>%
  ungroup()

# Build gt table
gt_table <- gt(carbon_table) %>%
  tab_header(
    title = md("**Table 5. Stock Price Effects by Carbon Credit Group**"),
    subtitle = "Post-Treatment Estimates Only (Years ≥ 0)"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

# Apply lighter row background colors
for (i in seq_len(nrow(carbon_table))) {
  original_group <- as.character(all_data$group[which(all_data$event_time >= 0)][i])
  gt_table <- gt_table %>%
    tab_style(
      style = cell_fill(color = colors[original_group]),
      locations = cells_body(rows = i)
    )
}

# Display final table
gt_table
```

## Interm Target
```{r Interm-heterogeneity, fig.width=10, fig.height=5, warning=FALSE, message=FALSE}
library(fixest)
library(dplyr)
library(gt)
library(grid)
library(gridExtra)
library(png)

# Ensure Interim_Target_Year is numeric
merged_data2 <- merged_data2 %>%
  mutate(Interim_Target_Year = as.numeric(Interim_Target_Year))

# Subset: Interim Target > 2000 or untreated
subset_after_2000 <- merged_data2 %>%
  filter((Treated == 1 & Interim_Target_Year > 2000) | Treated == 0)

# Subset: Interim Target < 2000 or untreated
subset_before_2000 <- merged_data2 %>%
  filter((Treated == 1 & Interim_Target_Year < 2000) | Treated == 0)

# Run models
model_after_2000 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_after_2000
)

model_before_2000 <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_before_2000
)

# Shared y-axis range
all_ci_vals <- c(confint(model_after_2000)[, 1:2], confint(model_before_2000)[, 1:2])
y_range <- range(all_ci_vals)

# Helper to create iplot grob (suppress title)
iplot_to_grob <- function(model, col = "black", col.border = "black", ylim_range = NULL) {
  temp <- tempfile(fileext = ".png")
  png(temp, width = 800, height = 600)

  event_times <- as.numeric(gsub("Year.x::", "", names(coef(model))))
  xlim_range <- range(event_times[!event_times %in% c(-6, 5, 6)])

  iplot(model,
        main = "",
        xlab = "Years Since Pledge",
        ylab = "Estimated Effect on Stock Price",
        col = col,
        col.border = col.border,
        ref.line = FALSE,
        xlim = xlim_range,
        ylim = ylim_range,
        cex = 2.5,
        lwd = 2.5,
        cex.lab = 1.4,
        cex.axis = 1.2
  )

  dev.off()
  img <- png::readPNG(temp)
  grid::rasterGrob(img, interpolate = TRUE)
}

# Plot colors
sky_blue <- "#87CEEB"
bubblegum_pink <- "#FF69B4"

# Create plot grobs
grob_after_raw  <- iplot_to_grob(model_after_2000, col = sky_blue, col.border = sky_blue, ylim_range = y_range)
grob_before_raw <- iplot_to_grob(model_before_2000, col = bubblegum_pink, col.border = bubblegum_pink, ylim_range = y_range)

# Create tight titles
title_after  <- textGrob("Interim Target", gp = gpar(fontsize = 16, fontface = "bold"), just = "center", vjust = 1)
title_before <- textGrob("No Interim Target", gp = gpar(fontsize = 16, fontface = "bold"), just = "center", vjust = 1)

# Combine each title + plot (tight spacing)
panel_after <- arrangeGrob(title_after, grob_after_raw, ncol = 1, heights = unit(c(0.2, 10), "null"))
panel_before <- arrangeGrob(title_before, grob_before_raw, ncol = 1, heights = unit(c(0.2, 10), "null"))

# Final figure layout
main_title <- textGrob("Figure 3: Interim Target Heterogeneity", gp = gpar(fontsize = 18, fontface = "bold"))
plots_row <- arrangeGrob(panel_after, panel_before, ncol = 2)
final_layout <- arrangeGrob(main_title, plots_row, ncol = 1, heights = unit(c(0.8, 10), "null"))

# Render figure
grid.newpage()
grid.draw(final_layout)

# ---- Table section ----

# Define light background colors
colors <- c(
  "Interim Target" = "#cce5f5",
  "No Interim Target" = "#fcd6e3"
)

group_order <- c("Interim Target", "No Interim Target")

# Extract post-treatment estimates
extract_vertical_interim <- function(model, label) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(event_time = as.numeric(gsub("Year.x::", "", term))) %>%
    filter(event_time >= 0) %>%
    mutate(
      Group = label,
      Year = as.character(event_time),
      Estimate = sprintf("%.2f", estimate),
      SE = sprintf("(%.2f)", std.error)
    ) %>%
    select(Group, Year, Estimate, SE)
}

# Combine and style table
interim_table <- bind_rows(
  extract_vertical_interim(model_after_2000, "Interim Target"),
  extract_vertical_interim(model_before_2000, "No Interim Target")
) %>%
  arrange(factor(Group, levels = group_order), as.numeric(Year)) %>%
  group_by(Group) %>%
  mutate(Group = ifelse(row_number() == 1, Group, "")) %>%
  ungroup()

gt_table <- gt(interim_table) %>%
  tab_header(
    title = md("**Table 6. Stock Price Effects by Interim Target Group**"),
    subtitle = "Post-Treatment Estimates Only (Years ≥ 0)"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

# Apply row shading
for (i in seq_len(nrow(interim_table))) {
  original_group <- ifelse(interim_table$Group[i] != "", interim_table$Group[i],
                           interim_table$Group[max(which(interim_table$Group[1:i] != ""))])
  gt_table <- gt_table %>%
    tab_style(
      style = cell_fill(color = colors[original_group]),
      locations = cells_body(rows = i)
    )
}

# Display final styled table
gt_table

```
```{r final-year-heterogeneity, fig.width=10, fig.height=5, warning=FALSE, message=FALSE}

library(fixest)
library(dplyr)
library(gt)
library(grid)
library(gridExtra)
library(png)

# Ensure Net_Zero_Year is numeric
merged_data2 <- merged_data2 %>%
  mutate(Net_Zero_Year = as.numeric(Net_Zero_Year))

# Subset for Net Zero Year ≤ 2035
subset_nz_before <- merged_data2 %>%
  filter((Treated == 1 & Net_Zero_Year <= 2035) | Treated == 0)

# Subset for Net Zero Year > 2035
subset_nz_after <- merged_data2 %>%
  filter((Treated == 1 & Net_Zero_Year > 2035) | Treated == 0)

# Run models
model_nz_before <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_nz_before
)

model_nz_after <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_nz_after
)

# Shared y-axis range
all_ci_vals <- c(confint(model_nz_before)[, 1:2], confint(model_nz_after)[, 1:2])
y_range <- range(all_ci_vals)

# iplot-to-grob function (with no internal title)
iplot_to_grob <- function(model, col = "black", col.border = "black", ylim_range = NULL) {
  temp <- tempfile(fileext = ".png")
  png(temp, width = 1600, height = 1200, res = 200)
  
  event_times <- as.numeric(gsub("Year.x::", "", names(coef(model))))
  xlim_range <- range(event_times[!event_times %in% c(-6, -5, 5, 6)])
  
  iplot(model,
        main = "",  # external titles instead
        xlab = "Years Since Pledge",
        ylab = "Estimated Effect on Stock Price",
        col = col,
        col.border = col.border,
        ref.line = FALSE,
        xlim = xlim_range,
        ylim = ylim_range,
        cex = 2.5,
        lwd = 2.5,
        cex.lab = 1.6,
        cex.axis = 1.4
  )
  
  dev.off()
  img <- png::readPNG(temp)
  grid::rasterGrob(img, interpolate = TRUE, width = unit(1, "npc"), height = unit(1, "npc"))
}

# Colors
deep_orange <- "#FF7F50"
rich_purple <- "#9370DB"

# Create plot grobs
grob_nz_before <- iplot_to_grob(model_nz_before, col = deep_orange, col.border = deep_orange, ylim_range = y_range)
grob_nz_after  <- iplot_to_grob(model_nz_after,  col = rich_purple, col.border = rich_purple, ylim_range = y_range)

# External titles
title_nz_before <- textGrob("Net Zero Year ≤ 2035", gp = gpar(fontsize = 16, fontface = "bold"))
title_nz_after  <- textGrob("Net Zero Year > 2035",  gp = gpar(fontsize = 16, fontface = "bold"))

# Combine each title + plot
panel_before <- arrangeGrob(
  textGrob(" ", gp = gpar(fontsize = 6)),  # spacer
  title_nz_before,
  grob_nz_before,
  ncol = 1,
  heights = unit(c(0.2, 0.8, 10), "null")
)

panel_after <- arrangeGrob(
  textGrob(" ", gp = gpar(fontsize = 6)),
  title_nz_after,
  grob_nz_after,
  ncol = 1,
  heights = unit(c(0.2, 0.8, 10), "null")
)

# Final layout
main_title <- textGrob("Figure 4: Net Zero Target Year Heterogeneity", gp = gpar(fontsize = 18, fontface = "bold"))
plots_row  <- arrangeGrob(panel_before, panel_after, ncol = 2)
final_layout <- arrangeGrob(main_title, plots_row, ncol = 1, heights = unit(c(0.8, 10), "null"))

# Render figure
grid.newpage()
grid.draw(final_layout)

# Color coding for table
colors <- c(
  "Net Zero ≤ 2035" = "#ffe5d0",   # light orange
  "Net Zero > 2035" = "#e0d3f5"    # light purple
)
group_order <- c("Net Zero ≤ 2035", "Net Zero > 2035")

# Extract post-treatment estimates in vertical layout
extract_vertical_nz <- function(model, label) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(event_time = as.numeric(gsub("Year.x::", "", term))) %>%
    filter(event_time >= 0) %>%
    mutate(
      Group = label,
      Year = as.character(event_time),
      Estimate = sprintf("%.2f", estimate),
      SE = sprintf("(%.2f)", std.error)
    ) %>%
    select(Group, Year, Estimate, SE)
}

# Combine
nz_table <- bind_rows(
  extract_vertical_nz(model_nz_before, "Net Zero ≤ 2035"),
  extract_vertical_nz(model_nz_after,  "Net Zero > 2035")
) %>%
  arrange(factor(Group, levels = group_order), as.numeric(Year)) %>%
  group_by(Group) %>%
  mutate(Group = ifelse(row_number() == 1, Group, "")) %>%
  ungroup()

# Build styled table
gt_table <- gt(nz_table) %>%
  tab_header(
    title = md("**Table 7. Stock Price Effects by Net Zero Year**"),
    subtitle = "Post-Treatment Estimates Only (Years ≥ 0)"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

# Apply row shading
for (i in seq_len(nrow(nz_table))) {
  original_group <- ifelse(nz_table$Group[i] != "", nz_table$Group[i],
                           nz_table$Group[max(which(nz_table$Group[1:i] != ""))])
  gt_table <- gt_table %>%
    tab_style(
      style = cell_fill(color = colors[original_group]),
      locations = cells_body(rows = i)
    )
}

# Display final table
gt_table

```

## Accountability Heterogeniety
```{r Accountability-heterogeneity, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}

# --- Not Specified Group ---
subset_acc_unspecified <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Not Specified") | Treated == 0)

staggered_model_unspecified <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_acc_unspecified
)

iplot(
  staggered_model_unspecified,
  main = "Staggered DiD: Accountability = Not Specified",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

# --- Yes Group ---
subset_acc_yes <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Yes") | Treated == 0)

staggered_model_yes <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_acc_yes
)

iplot(
  staggered_model_yes,
  main = "Staggered DiD: Accountability = Yes",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)

# --- No Group ---
subset_acc_no <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "No") | Treated == 0)

staggered_model_no <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_acc_no
)

iplot(
  staggered_model_no,
  main = "Staggered DiD: Accountability = No",
  xlab = "Years Since Pledge",
  ylab = "Effect on Stock Price"
)
## Plotting Side by Side

#--- Helper to create grob from iplot
iplot_to_grob <- function(model, title) {
  temp <- tempfile(fileext = ".png")
  png(temp, width = 800, height = 600)
  iplot(model, main = title, xlab = "Years Since Pledge", ylab = "Effect on Stock Price")
  dev.off()
  img <- png::readPNG(temp)
  rasterGrob(img, interpolate = TRUE)
}

#--- Not Specified Group
subset_unspecified <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Not Specified") | Treated == 0)

model_unspecified <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_unspecified
)

grob_unspecified <- iplot_to_grob(model_unspecified, "Accountability: Not Specified")

#--- Yes Group
subset_yes <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "Yes") | Treated == 0)

model_yes <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_yes
)

grob_yes <- iplot_to_grob(model_yes, "Accountability: Yes")

#--- No Group
subset_no <- merged_data2 %>%
  filter((Treated == 1 & Accountability_delivery == "No") | Treated == 0)

model_no <- feols(
  Avg_Stock_Price ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
  data = subset_no
)

grob_no <- iplot_to_grob(model_no, "Accountability: No")

#--- Combine Plots Side by Side
grid.arrange(
  grob_unspecified, grob_yes, grob_no,
  ncol = 3,
  top = textGrob("Figure: Accountability Delivery Heterogeneity", gp = gpar(fontsize = 14, fontface = "bold"))
)
## Tabling
# Extract and prepare results
tidy_group <- function(model, label) {
  tidy(model) %>%
    filter(grepl("Year.x::", term)) %>%
    mutate(
      group = label,
      event_time = gsub("Year.x::", "Year ", term),
      estimate = sprintf("%.2f", estimate),
      std.error = sprintf("(%.2f)", std.error)
    ) %>%
    select(group, event_time, estimate, std.error)
}

results_combined <- bind_rows(
  tidy_group(model_unspecified, "Not Specified"),
  tidy_group(model_yes, "Yes"),
  tidy_group(model_no, "No")
)

# Stack estimates and SEs as rows
results_long <- results_combined %>%
  pivot_longer(cols = c(estimate, std.error), names_to = "stat", values_to = "value") %>%
  mutate(label = ifelse(stat == "estimate", group, paste0(group, " (SE)"))) %>%
  select(label, event_time, value) %>%
  pivot_wider(names_from = event_time, values_from = value)

# Display the table
gt(results_long) %>%
  tab_header(title = "Table: Stock Price Impact by Accountability Delivery") %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )

```
