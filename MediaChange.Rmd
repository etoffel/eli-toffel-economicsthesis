---
title: "Event Study: Media Coverage and Tone Around Carbon Pledges"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(fixest)
library(broom)
library(modelsummary)
library(ggplot2)
```

## 1. Load and Prepare Data
```{r load-data}
source("housekeeping.R")

pulled_together <- read_csv("data/clean/MediaDataPulledTogether.csv") %>%
  rename(
    Media_Articles_Total = `Number of Media Articles Total`,
    Negative_Business_Articles = `Negative Business Articles`,
    Negative_Personal_Articles = `Negative Personal Articles`,
    Nexis_Input = `Input into Nexis`,
    Parent_Company = `Parent Company`
  ) %>%
  select(-Nexis_Input, -Parent_Company) %>%
  filter(!is.na(Media_Articles_Total), Years_to_Pledge <= 10, !is.na(Unique_ID)) %>%
  mutate(Year.y = ifelse(Year.y == 0, NA, Year.y))
```

## 2. Main Event Study: Media Coverage
```{r media-regression}
event_study_media <- feols(
  Media_Articles_Total ~ i(Years_to_Pledge, Target_Category, ref = -1) | Unique_ID + Year.x,
  data = pulled_together
)
summary(event_study_media)
```

## 3. Create Share of Negative Media Coverage
```{r percent-negative}
pulled_together <- pulled_together %>%
  mutate(
    Percent_Negative_Business = ifelse(Media_Articles_Total > 0,
      pmin(Negative_Business_Articles / Media_Articles_Total * 100, 100), NA),
    Percent_Negative_Personal = ifelse(Media_Articles_Total > 0,
      pmin(Negative_Personal_Articles / Media_Articles_Total * 100, 100), NA)
  )
```

## 4. Run Additional Event Studies: Tone
```{r tone-regressions}
event_study_media_business <- feols(
  Percent_Negative_Business ~ i(Years_to_Pledge, Target_Category, ref = -1) | Unique_ID + Year.x,
  data = pulled_together
)

event_study_media_personal <- feols(
  Percent_Negative_Personal ~ i(Years_to_Pledge, Target_Category, ref = -1) | Unique_ID + Year.x,
  data = pulled_together
)
```

## 5. Visualization: Media Article Counts
```{r plot-media-articles}
event_plot_data <- tidy(event_study_media, conf.int = TRUE) %>%
  filter(str_detect(term, "Years_to_Pledge")) %>%
  separate(term, into = c("Years_to_Pledge", "Target_Category"), sep = ":Target_Category::") %>%
  mutate(
    Years_to_Pledge = as.numeric(gsub("Years_to_Pledge::", "", Years_to_Pledge)),
    Target_Category = factor(Target_Category)
  ) %>%
  filter(!is.na(Years_to_Pledge), Years_to_Pledge >= -3, Target_Category != "Other")

ggplot(event_plot_data, aes(x = Years_to_Pledge, y = estimate, color = Target_Category)) +
  geom_line(size = 1) +
  geom_point() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = Target_Category), alpha = 0.2, color = NA) +
  geom_vline(xintercept = -1, linetype = "dashed", color = "black") +
  labs(
    title = "Media Coverage Over Time by Target Category",
    x = "Years to Pledge",
    y = "Estimated Change in Media Articles"
  ) +
  theme_minimal()
```

## 6. Visualization: Tone Over Time
```{r plot-tone}
# Business Tone
plot_business <- tidy(event_study_media_business, conf.int = TRUE) %>%
  filter(str_detect(term, "Years_to_Pledge")) %>%
  separate(term, into = c("Years_to_Pledge", "Target_Category"), sep = ":Target_Category::") %>%
  mutate(
    Years_to_Pledge = as.numeric(gsub("Years_to_Pledge::", "", Years_to_Pledge)),
    Target_Category = factor(Target_Category)
  ) %>%
  filter(!is.na(Years_to_Pledge), Years_to_Pledge >= -3, Target_Category != "Other")

ggplot(plot_business, aes(x = Years_to_Pledge, y = estimate, color = Target_Category)) +
  geom_line(size = 1) +
  geom_point() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = Target_Category), alpha = 0.2, color = NA) +
  geom_vline(xintercept = -1, linetype = "dashed", color = "black") +
  labs(
    title = "Negative Business Articles Over Time",
    x = "Years to Pledge",
    y = "% Negative Business Coverage"
  ) +
  theme_minimal()

# Personal Tone
plot_personal <- tidy(event_study_media_personal, conf.int = TRUE) %>%
  filter(str_detect(term, "Years_to_Pledge")) %>%
  separate(term, into = c("Years_to_Pledge", "Target_Category"), sep = ":Target_Category::") %>%
  mutate(
    Years_to_Pledge = as.numeric(gsub("Years_to_Pledge::", "", Years_to_Pledge)),
    Target_Category = factor(Target_Category)
  ) %>%
  filter(!is.na(Years_to_Pledge), Years_to_Pledge >= -3, Target_Category != "Other")

ggplot(plot_personal, aes(x = Years_to_Pledge, y = estimate, color = Target_Category)) +
  geom_line(size = 1) +
  geom_point() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = Target_Category), alpha = 0.2, color = NA) +
  geom_vline(xintercept = -1, linetype = "dashed", color = "black") +
  labs(
    title = "Negative Personal Articles Over Time",
    x = "Years to Pledge",
    y = "% Negative Personal Coverage"
  ) +
  theme_minimal()
```

## 7. Staggered DiDs
```{r staggered-did-media}

##Total Media Coverage
staggered_did <- feols(Media_Articles_Total ~ sunab(Year.y, Year.x) | Unique_ID + Year.x,
                       data = pulled_together)
summary(staggered_did)

iplot(staggered_did, main = "Staggered DiD: Media Articles", xlab = "Years Since Pledge")

## Percent_Negative_Business Staggered DiD
staggered_did_bus <- feols(Percent_Negative_Business ~ sunab(Year.y, Year.x) | Unique_ID + Year.x, 
                       data = pulled_together)

summary(staggered_did_bus)

iplot(staggered_did_bus, main = "Staggered DiD: Negative Business Media Articles", xlab = "Years Since Pledge")

## Percent_Negative_Personal Staggered DiD
staggered_did_pers <- feols(Percent_Negative_Personal ~ sunab(Year.y, Year.x)| Unique_ID + Year.x, 
                       data = pulled_together)

summary(staggered_did_pers)

iplot(staggered_did_pers, main = "Staggered DiD: Negative Business Media Articles", xlab = "Years Since Pledge")



```

## 8. Filter & Retable Results
```{r reestimate-and-table}
filtered_data <- pulled_together %>%
  filter(Target_Category != "Other", Years_to_Pledge >= -3)

event_study_media <- feols(Media_Articles_Total ~ i(Years_to_Pledge, Target_Category, ref = -1) | Unique_ID + Year.x, data = filtered_data)
event_study_media_business <- feols(Percent_Negative_Business ~ i(Years_to_Pledge, Target_Category, ref = -1) | Unique_ID + Year.x, data = filtered_data)
event_study_media_personal <- feols(Percent_Negative_Personal ~ i(Years_to_Pledge, Target_Category, ref = -1) | Unique_ID + Year.x, data = filtered_data)

modelsummary(
  list(
    "Total Media Articles" = event_study_media,
    "Negative Business (%)" = event_study_media_business,
    "Negative Personal (%)" = event_study_media_personal
  ),
  stars = TRUE,
  estimate = "{estimate} ({std.error})",
  statistic = "p.value",
  gof_omit = "IC|Log|Adj|Within|Pseudo|F",
  output = "markdown"
)
```
## 9. Adding Reputation as a Control
```{r reputation, eval=FALSE}
##Data Merging
reputation_data <- read_csv("data/Build 2/Reputation Data.csv") %>%
  rename(Unique_ID = `Unique ID`, Year.x = Year)

media_with_rep <- pulled_together %>%
  left_join(reputation_data, by = c("Unique_ID", "Year.x"))

## Total Media Staggered DiD
staggered_did <- feols(Media_Articles_Total ~ sunab(Year.y, Year.x) + Reputation_Score| Unique_ID + Year.x, 
                       data = media_with_rep)
summary(staggered_did)

iplot(staggered_did, main = "Staggered DiD: Media Articles", xlab = "Years Since Pledge")

## Percent_Negative_Business Staggered DiD
staggered_did_bus <- feols(Percent_Negative_Business ~ sunab(Year.y, Year.x) + Reputation_Score| Unique_ID + Year.x, 
                       data = media_with_rep)

summary(staggered_did_bus)

iplot(staggered_did_bus, main = "Staggered DiD: Negative Business Media Articles", xlab = "Years Since Pledge")

## Percent_Negative_Personal Staggered DiD
staggered_did_pers <- feols(Percent_Negative_Personal ~ sunab(Year.y, Year.x) + Reputation_Score| Unique_ID + Year.x, 
                       data = media_with_rep)

summary(staggered_did_pers)

iplot(staggered_did_pers, main = "Staggered DiD: Negative Business Media Articles", xlab = "Years Since Pledge")


```
## 10. Export Results (Optional)
```{r export-word, eval=FALSE}
modelsummary(
  list(
    "Total Media Articles" = event_study_media,
    "Negative Business (%)" = event_study_media_business,
    "Negative Personal (%)" = event_study_media_personal
  ),
  stars = TRUE,
  estimate = "{estimate} ({std.error})",
  statistic = "p.value",
  gof_omit = "IC|Log|Adj|Within|Pseudo|F",
  output = "output/event_study_results.docx"  # Adjust path as needed
)
```